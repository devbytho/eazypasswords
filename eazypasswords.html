<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecurePass - Password Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a56d4;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.05);
            --transition: all 0.2s ease;
        }

        /* Dark mode variables */
        .dark-mode {
            --primary: #4f6fee;
            --secondary: #435fd8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #0f172a;
            --dark: #f1f5f9;
            --gray: #94a3b8;
            --gray-light: #1e293b;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            transition: var(--transition);
            font-weight: 400;
        }

        /* Auth Screens */
        .auth-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-box {
            background: var(--light);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: clamp(24px, 5vw, 40px);
            width: 100%;
            max-width: min(400px, 90vw);
            text-align: center;
            border: 1px solid var(--gray-light);
        }

        .auth-logo {
            margin-bottom: clamp(20px, 4vw, 30px);
        }

        .auth-logo i {
            font-size: clamp(36px, 8vw, 48px);
            color: var(--primary);
            margin-bottom: clamp(10px, 2vw, 15px);
        }

        .auth-logo h1 {
            font-size: clamp(22px, 5vw, 28px);
            font-weight: 700;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .auth-logo p {
            color: var(--gray);
            margin-top: 5px;
            font-size: clamp(12px, 3vw, 14px);
        }

        .form-group {
            margin-bottom: clamp(16px, 3vw, 20px);
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: clamp(13px, 3vw, 14px);
        }

        .form-control {
            width: 100%;
            padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 16px);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: clamp(14px, 3.5vw, 15px);
            transition: var(--transition);
            background-color: var(--light);
            color: var(--dark);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .password-input {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: clamp(10px, 2.5vw, 12px);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 4px;
            font-size: clamp(14px, 3vw, 16px);
        }

        .btn {
            width: 100%;
            padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 16px);
            border: none;
            border-radius: var(--border-radius);
            font-size: clamp(14px, 3.5vw, 15px);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
            border: 1px solid var(--gray-light);
        }

        .btn-secondary:hover {
            background: var(--gray);
            border-color: var(--gray);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .auth-footer {
            text-align: center;
            margin-top: clamp(20px, 4vw, 30px);
            color: var(--gray);
            font-size: clamp(12px, 3vw, 14px);
        }

        .auth-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .alert {
            padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 16px);
            border-radius: var(--border-radius);
            margin-bottom: clamp(16px, 3vw, 20px);
            display: none;
            font-size: clamp(12px, 3vw, 14px);
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid var(--success);
            color: var(--success);
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: clamp(240px, 25vw, 260px);
            background: var(--light);
            color: var(--dark);
            padding: 0;
            transition: var(--transition);
            border-right: 1px solid var(--gray-light);
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            padding: clamp(16px, 3vw, 24px);
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 8px;
        }

        .logo i {
            font-size: clamp(20px, 4vw, 24px);
            margin-right: clamp(8px, 2vw, 12px);
            color: var(--primary);
        }

        .logo h1 {
            font-size: clamp(16px, 3.5vw, 20px);
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-links {
            list-style: none;
            padding: 0;
            flex: 1;
        }

        .nav-links li {
            margin: 4px clamp(12px, 2vw, 16px);
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: clamp(10px, 2vw, 12px) clamp(12px, 2.5vw, 16px);
            color: var(--gray);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: clamp(13px, 2.5vw, 14px);
            font-weight: 500;
        }

        .nav-links a:hover {
            background: var(--gray-light);
            color: var(--dark);
        }

        .nav-links a.active {
            background: var(--primary);
            color: white;
        }

        .nav-links i {
            margin-right: clamp(8px, 2vw, 12px);
            font-size: clamp(14px, 3vw, 16px);
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: clamp(16px, 3vw, 20px);
            margin-top: auto;
            border-top: 1px solid var(--gray-light);
        }

        .upgrade-card {
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: clamp(16px, 3vw, 20px);
            text-align: center;
        }

        .upgrade-icon {
            width: clamp(36px, 8vw, 40px);
            height: clamp(36px, 8vw, 40px);
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto clamp(8px, 2vw, 12px);
            color: white;
            font-size: clamp(14px, 3vw, 16px);
        }

        .upgrade-title {
            font-size: clamp(13px, 2.5vw, 14px);
            font-weight: 600;
            margin-bottom: clamp(6px, 1.5vw, 8px);
            color: var(--dark);
        }

        .upgrade-description {
            font-size: clamp(11px, 2vw, 12px);
            color: var(--gray);
            margin-bottom: clamp(12px, 3vw, 16px);
            line-height: 1.4;
        }

        .upgrade-btn-sidebar {
            display: block;
            width: 100%;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: clamp(12px, 2.5vw, 13px);
        }

        .upgrade-btn-sidebar:hover {
            background: var(--secondary);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: clamp(16px, 3vw, 24px);
            overflow-y: auto;
            background: var(--light);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(20px, 4vw, 32px);
            gap: clamp(12px, 3vw, 16px);
            flex-wrap: wrap;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--light);
            border-radius: var(--border-radius);
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            border: 1px solid var(--gray-light);
            width: min(400px, 100%);
            transition: var(--transition);
            flex: 1;
            min-width: 200px;
        }

        .search-bar:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .search-bar i {
            color: var(--gray);
            margin-right: clamp(8px, 2vw, 12px);
            font-size: clamp(14px, 3vw, 16px);
        }

        .search-bar input {
            border: none;
            outline: none;
            width: 100%;
            font-size: clamp(14px, 3.5vw, 15px);
            background: var(--light);
            color: var(--dark);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: clamp(12px, 3vw, 16px);
        }

        .theme-toggle, .notification-icon, .user-profile {
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            padding: clamp(6px, 1.5vw, 8px);
            border-radius: var(--border-radius);
            font-size: clamp(16px, 3.5vw, 18px);
        }

        .theme-toggle:hover, .notification-icon:hover {
            background: var(--gray-light);
            color: var(--dark);
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: clamp(6px, 1.5vw, 8px) clamp(8px, 2vw, 12px);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .user-profile:hover {
            background: var(--gray-light);
        }

        .user-profile img {
            width: clamp(28px, 6vw, 32px);
            height: clamp(28px, 6vw, 32px);
            border-radius: 50%;
            margin-right: clamp(6px, 1.5vw, 8px);
            object-fit: cover;
        }

        .user-profile span {
            font-weight: 500;
            font-size: clamp(13px, 2.5vw, 14px);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
            gap: clamp(16px, 3vw, 20px);
            margin-bottom: clamp(24px, 5vw, 32px);
        }

        .card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: clamp(20px, 4vw, 24px);
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .card-title {
            font-size: clamp(14px, 3vw, 16px);
            font-weight: 600;
            color: var(--gray);
        }

        .card-icon {
            width: clamp(36px, 8vw, 40px);
            height: clamp(36px, 8vw, 40px);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: clamp(14px, 3vw, 16px);
        }

        .card-icon.primary {
            background: var(--primary);
        }

        .card-icon.success {
            background: var(--success);
        }

        .card-icon.warning {
            background: var(--warning);
        }

        .card-icon.danger {
            background: var(--danger);
        }

        .card-value {
            font-size: clamp(24px, 6vw, 32px);
            font-weight: 700;
            margin-bottom: clamp(6px, 1.5vw, 8px);
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .card-description {
            color: var(--gray);
            font-size: clamp(12px, 2.5vw, 14px);
        }

        /* Password List */
        .password-list {
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
            overflow: hidden;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(16px, 3vw, 20px) clamp(20px, 4vw, 24px);
            border-bottom: 1px solid var(--gray-light);
            flex-wrap: wrap;
            gap: 12px;
        }

        .list-title {
            font-size: clamp(16px, 3.5vw, 18px);
            font-weight: 600;
            color: var(--dark);
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: clamp(8px, 2vw, 10px) clamp(16px, 3vw, 20px);
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: var(--transition);
            font-size: clamp(13px, 2.5vw, 14px);
            font-weight: 500;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: var(--secondary);
        }

        .add-btn i {
            margin-right: clamp(6px, 1.5vw, 8px);
            font-size: clamp(13px, 2.5vw, 14px);
        }

        .password-item {
            display: flex;
            align-items: center;
            padding: clamp(12px, 2.5vw, 16px) clamp(16px, 3vw, 24px);
            border-bottom: 1px solid var(--gray-light);
            transition: var(--transition);
            flex-wrap: wrap;
            gap: 12px;
        }

        .password-item:hover {
            background: var(--gray-light);
        }

        .password-item:last-child {
            border-bottom: none;
        }

        .password-icon {
            width: clamp(36px, 8vw, 40px);
            height: clamp(36px, 8vw, 40px);
            border-radius: var(--border-radius);
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: clamp(12px, 3vw, 16px);
            font-size: clamp(13px, 2.5vw, 14px);
            flex-shrink: 0;
        }

        .password-details {
            flex: 1;
            min-width: 200px;
        }

        .password-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
            font-size: clamp(14px, 3vw, 15px);
            word-break: break-word;
        }

        .password-username {
            color: var(--gray);
            font-size: clamp(12px, 2.5vw, 13px);
            word-break: break-word;
        }

        .password-actions {
            display: flex;
            gap: clamp(6px, 1.5vw, 8px);
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: clamp(14px, 3vw, 15px);
            transition: var(--transition);
            padding: clamp(4px, 1vw, 6px);
            border-radius: 4px;
        }

        .action-btn:hover {
            color: var(--primary);
            background: var(--gray-light);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: clamp(12px, 3vw, 20px);
        }

        .modal-content {
            background: var(--light);
            border-radius: 12px;
            width: min(500px, 95vw);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: modalFadeIn 0.2s;
            border: 1px solid var(--gray-light);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: clamp(16px, 3vw, 20px) clamp(20px, 4vw, 24px);
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--light);
            z-index: 1;
        }

        .modal-title {
            font-size: clamp(16px, 3.5vw, 18px);
            font-weight: 600;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: clamp(18px, 4vw, 20px);
            cursor: pointer;
            color: var(--gray);
            padding: 4px;
            border-radius: 4px;
        }

        .close-modal:hover {
            background: var(--gray-light);
        }

        .modal-body {
            padding: clamp(20px, 4vw, 24px);
        }

        .modal-footer {
            padding: clamp(16px, 3vw, 20px) clamp(20px, 4vw, 24px);
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: clamp(8px, 2vw, 12px);
            position: sticky;
            bottom: 0;
            background: var(--light);
            z-index: 1;
        }

        /* PIN Modal Styles */
        .pin-inputs {
            display: flex;
            justify-content: center;
            gap: clamp(8px, 2vw, 12px);
            margin: clamp(16px, 3vw, 24px) 0;
        }

        .pin-input {
            width: clamp(40px, 10vw, 50px);
            height: clamp(48px, 12vw, 60px);
            text-align: center;
            font-size: clamp(18px, 4.5vw, 24px);
            border: 3px solid color-mix(in srgb, var(--gray) 50%, var(--gray-light) 50%);
            border-radius: var(--border-radius);
            transition: var(--transition);
            background-color: var(--light);
            color: var(--dark);
        }

        .pin-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .security-indicator {
            height: 4px;
            background: var(--gray-light);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .security-strength {
            height: 100%;
            width: 0%;
            transition: var(--transition);
        }

        .security-weak {
            background: var(--danger);
            width: 33%;
        }

        .security-medium {
            background: var(--warning);
            width: 66%;
        }

        .security-strong {
            background: var(--success);
            width: 100%;
        }

        .loading {
            display: none;
            text-align: center;
            padding: clamp(30px, 6vw, 40px) clamp(16px, 3vw, 20px);
        }

        .spinner {
            border: 3px solid var(--gray-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: clamp(24px, 6vw, 30px);
            height: clamp(24px, 6vw, 30px);
            animation: spin 1s linear infinite;
            margin: 0 auto clamp(12px, 3vw, 16px);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: clamp(40px, 8vw, 60px) clamp(16px, 3vw, 20px);
            color: var(--gray);
        }

        .empty-state i {
            font-size: clamp(36px, 8vw, 48px);
            margin-bottom: clamp(12px, 3vw, 16px);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: clamp(16px, 3.5vw, 18px);
            margin-bottom: clamp(6px, 1.5vw, 8px);
            color: var(--dark);
        }

        .empty-state p {
            font-size: clamp(12px, 2.5vw, 14px);
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: clamp(12px, 3vw, 20px);
            right: clamp(12px, 3vw, 20px);
            background: var(--success);
            color: white;
            padding: clamp(10px, 2.5vw, 12px) clamp(16px, 3vw, 20px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-size: clamp(12px, 2.5vw, 14px);
            max-width: min(400px, 90vw);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification i {
            font-size: clamp(14px, 3vw, 16px);
        }

        /* Settings Styles */
        .settings-container {
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
            padding: 0;
            overflow: hidden;
        }

        .settings-section {
            padding: clamp(20px, 4vw, 24px);
            border-bottom: 1px solid var(--gray-light);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-title {
            font-size: clamp(14px, 3vw, 16px);
            font-weight: 600;
            margin-bottom: clamp(16px, 3vw, 20px);
            color: var(--dark);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(12px, 2.5vw, 16px) 0;
            flex-wrap: wrap;
            gap: 12px;
        }

        .settings-item:not(:last-child) {
            border-bottom: 1px solid var(--gray-light);
        }

        .settings-label {
            font-weight: 500;
            font-size: clamp(13px, 2.5vw, 14px);
        }

        .settings-description {
            color: var(--gray);
            font-size: clamp(12px, 2.5vw, 13px);
            margin-top: 4px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: clamp(40px, 9vw, 44px);
            height: clamp(20px, 4.5vw, 24px);
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: .2s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: clamp(16px, 3.5vw, 18px);
            width: clamp(16px, 3.5vw, 18px);
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Biometric Section */
        .biometric-options {
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 3vw, 16px);
            margin-top: clamp(12px, 3vw, 16px);
        }

        .biometric-option {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
            padding: clamp(10px, 2.5vw, 12px);
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }

        .biometric-icon {
            width: clamp(32px, 7vw, 36px);
            height: clamp(32px, 7vw, 36px);
            border-radius: 50%;
            background: var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(14px, 3vw, 16px);
            color: var(--gray);
        }

        /* Danger Zone */
        .danger-zone {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--border-radius);
            padding: clamp(20px, 4vw, 24px);
            margin-top: 8px;
        }

        .dark-mode .danger-zone {
            background: #1f1b1b;
            border-color: #7f1d1d;
        }

        .danger-zone .settings-title {
            color: var(--danger);
        }

        .danger-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: clamp(8px, 2vw, 10px) clamp(16px, 3vw, 20px);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: clamp(13px, 2.5vw, 14px);
        }

        .danger-btn:hover {
            background: #dc2626;
        }

        /* Premium Features Styles */
        .premium-feature {
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: clamp(24px, 5vw, 40px);
            text-align: center;
            margin-bottom: clamp(24px, 5vw, 32px);
        }

        .premium-icon {
            font-size: clamp(48px, 10vw, 64px);
            margin-bottom: clamp(16px, 3vw, 24px);
            color: var(--primary);
        }

        .premium-title {
            font-size: clamp(20px, 5vw, 28px);
            font-weight: 700;
            margin-bottom: clamp(12px, 3vw, 16px);
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .premium-description {
            font-size: clamp(14px, 3.5vw, 16px);
            margin-bottom: clamp(24px, 5vw, 32px);
            color: var(--gray);
            max-width: min(500px, 90vw);
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        .premium-benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
            gap: clamp(16px, 3vw, 24px);
            margin: clamp(24px, 5vw, 40px) 0;
        }

        .benefit-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: clamp(20px, 4vw, 24px);
            text-align: center;
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .benefit-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .benefit-icon {
            width: clamp(48px, 10vw, 60px);
            height: clamp(48px, 10vw, 60px);
            border-radius: var(--border-radius);
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto clamp(16px, 3vw, 20px);
            color: white;
            font-size: clamp(18px, 4vw, 24px);
        }

        .benefit-title {
            font-weight: 600;
            margin-bottom: clamp(8px, 2vw, 12px);
            color: var(--dark);
            font-size: clamp(14px, 3vw, 16px);
        }

        .benefit-description {
            color: var(--gray);
            font-size: clamp(12px, 2.5vw, 14px);
            line-height: 1.5;
        }

        .pricing-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
            gap: clamp(16px, 3vw, 24px);
            margin-top: clamp(24px, 5vw, 40px);
        }

        .pricing-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: clamp(24px, 5vw, 32px);
            text-align: center;
            border: 1px solid var(--gray-light);
            transition: var(--transition);
            position: relative;
        }

        .pricing-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .pricing-card.featured {
            border-color: var(--primary);
        }

        .pricing-card.featured::before {
            content: "Most Popular";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: clamp(11px, 2.5vw, 12px);
            font-weight: 600;
        }

        .plan-name {
            font-size: clamp(16px, 3.5vw, 20px);
            font-weight: 600;
            margin-bottom: clamp(8px, 2vw, 12px);
            color: var(--dark);
        }

        .plan-price {
            font-size: clamp(32px, 8vw, 40px);
            font-weight: 700;
            margin-bottom: clamp(6px, 1.5vw, 8px);
            color: var(--primary);
            letter-spacing: -1px;
        }

        .plan-period {
            font-size: clamp(12px, 2.5vw, 14px);
            color: var(--gray);
            margin-bottom: clamp(16px, 3vw, 24px);
        }

        .plan-features {
            list-style: none;
            margin: clamp(20px, 4vw, 28px) 0;
            text-align: left;
        }

        .plan-features li {
            padding: clamp(8px, 2vw, 10px) 0;
            color: var(--dark);
            border-bottom: 1px solid var(--gray-light);
            font-size: clamp(12px, 2.5vw, 14px);
        }

        .plan-features li:last-child {
            border-bottom: none;
        }

        .plan-features li i {
            color: var(--success);
            margin-right: clamp(8px, 2vw, 12px);
            font-size: clamp(12px, 2.5vw, 14px);
        }

        .plan-features li .fa-times {
            color: var(--danger);
        }

        /* Current Plan Info */
        .current-plan-info {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray);
        }

        .current-plan-info h3 {
            font-size: clamp(16px, 3.5vw, 18px);
            margin-bottom: 8px;
            color: var(--dark);
        }

        .current-plan-info p {
            color: var(--gray);
            font-size: clamp(12px, 2.5vw, 14px);
        }

        .missing-features {
            margin-top: 15px;
            padding: 15px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid var(--danger);
            text-align: left;
        }

        .missing-features h4 {
            color: var(--danger);
            margin-bottom: 10px;
            font-size: clamp(14px, 3vw, 15px);
        }

        .missing-features ul {
            color: var(--danger);
            padding-left: 20px;
        }

        .missing-features li {
            margin-bottom: 5px;
            font-size: clamp(12px, 2.5vw, 13px);
        }

        /* Feature Access Styles */
        .feature-access {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: clamp(40px, 8vw, 60px) clamp(20px, 4vw, 30px);
            text-align: center;
        }

        .feature-access-icon {
            font-size: clamp(48px, 10vw, 64px);
            margin-bottom: clamp(16px, 3vw, 24px);
            color: var(--primary);
        }

        .feature-access-title {
            font-size: clamp(20px, 5vw, 28px);
            font-weight: 700;
            margin-bottom: clamp(12px, 3vw, 16px);
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .feature-access-description {
            font-size: clamp(14px, 3.5vw, 16px);
            margin-bottom: clamp(24px, 5vw, 32px);
            color: var(--gray);
            max-width: min(500px, 90vw);
            line-height: 1.6;
        }

        .required-plan {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: clamp(12px, 2.5vw, 14px);
            font-weight: 600;
            margin-top: 8px;
        }

        /* Sharing and Family Styles */
        .share-options {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }
        
        .family-member-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
        }
        
        .family-member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .family-member-info {
            flex: 1;
        }
        
        .family-member-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .family-member-role {
            color: var(--gray);
            font-size: 14px;
        }
        
        .share-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
        }
        
        .share-info {
            flex: 1;
        }
        
        .share-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: var(--success);
            color: white;
        }
        
        .status-expired {
            background: var(--danger);
            color: white;
        }
        
        .emergency-access-banner {
            background: linear-gradient(135deg, var(--warning), #f59e0b);
            color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: clamp(200px, 20vw, 240px);
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .search-bar {
                width: 100%;
                margin-bottom: 16px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .pricing-plans {
                grid-template-columns: 1fr;
            }

            .premium-feature {
                padding: 20px;
            }

            .premium-icon {
                font-size: 48px;
            }

            .premium-title {
                font-size: 24px;
            }

            .user-actions {
                justify-content: space-between;
                width: 100%;
            }

            .password-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .password-actions {
                align-self: flex-end;
            }
        }

        @media (max-width: 480px) {
            .auth-box {
                padding: 20px;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .premium-benefits {
                grid-template-columns: 1fr;
            }
            
            .user-actions {
                gap: 8px;
            }
            
            .user-profile span {
                display: none;
            }

            .modal-body {
                padding: 16px;
            }

            .modal-header, .modal-footer {
                padding: 12px 16px;
            }

            .pin-inputs {
                gap: 8px;
            }

            .pin-input {
                width: 45px;
                height: 50px;
                font-size: 20px;
            }

            .password-details {
                min-width: unset;
                width: 100%;
            }
        }

        @media (max-width: 360px) {
            .auth-box {
                padding: 16px;
            }

            .main-content {
                padding: 8px;
            }

            .card {
                padding: 16px;
            }

            .password-item {
                padding: 12px 16px;
            }

            .list-header {
                padding: 12px 16px;
            }

            .modal-content {
                width: 98vw;
            }

            .pin-input {
                width: 40px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screens -->
    <div class="auth-container" id="authContainer">
        <!-- Login Screen -->
        <div class="auth-box" id="loginScreen">
            <div class="auth-logo">
                <i class="fas fa-lock"></i>
                <h1>SecurePass</h1>
                <p>Your secure password manager</p>
            </div>

            <div class="alert" id="loginAlert"></div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email">
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-input">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password">
                    <button type="button" class="toggle-password" onclick="togglePassword('loginPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <button class="btn btn-primary" onclick="login()">Sign In</button>

            <div class="auth-footer">
                Don't have an account? <span class="auth-link" onclick="showAuthScreen('registerScreen')">Sign Up</span>
            </div>

            <div style="text-align: center; margin-top: 15px;">
                <span class="auth-link" onclick="showAuthScreen('forgotPasswordScreen')">Forgot Password?</span>
            </div>
        </div>

        <!-- Register Screen -->
        <div class="auth-box" id="registerScreen" style="display: none;">
            <div class="auth-logo">
                <i class="fas fa-lock"></i>
                <h1>Create Account</h1>
                <p>Join SecurePass today</p>
            </div>

            <div class="alert" id="registerAlert"></div>

            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-control" id="registerName" placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="registerEmail" placeholder="Enter your email">
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-input">
                    <input type="password" class="form-control" id="registerPassword" placeholder="Create a password">
                    <button type="button" class="toggle-password" onclick="togglePassword('registerPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">4-Digit PIN</label>
                <input type="password" class="form-control" id="registerPin" placeholder="Enter a 4-digit PIN" maxlength="4" pattern="\d{4}">
            </div>

            <button class="btn btn-primary" onclick="register()">Create Account</button>

            <div class="auth-footer">
                Already have an account? <span class="auth-link" onclick="showAuthScreen('loginScreen')">Sign In</span>
            </div>
        </div>

        <!-- Verify Email Screen -->
        <div class="auth-box" id="verifyScreen" style="display: none;">
            <div class="auth-logo">
                <i class="fas fa-envelope"></i>
                <h1>Verify Email</h1>
                <p>Enter the code sent to your email</p>
            </div>

            <div class="alert" id="verifyAlert"></div>

            <div class="form-group">
                <label class="form-label">Verification Code</label>
                <input type="text" class="form-control" id="verifyCode" placeholder="Enter 6-digit code">
            </div>

            <button class="btn btn-primary" onclick="verifyEmail()">Verify Email</button>

            <div class="auth-footer">
                Didn't receive code? <span class="auth-link" onclick="resendCode()">Resend</span>
            </div>
        </div>

        <!-- Forgot Password Screen -->
        <div class="auth-box" id="forgotPasswordScreen" style="display: none;">
            <div class="auth-logo">
                <i class="fas fa-key"></i>
                <h1>Reset Password</h1>
                <p>Enter your email to receive a reset link</p>
            </div>

            <div class="alert" id="forgotPasswordAlert"></div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="forgotPasswordEmail" placeholder="Enter your email">
            </div>

            <button class="btn btn-primary" onclick="sendResetLink()">Send Reset Link</button>

            <div class="auth-footer">
                Remember your password? <span class="auth-link" onclick="showAuthScreen('loginScreen')">Sign In</span>
            </div>
        </div>

        <!-- Reset Password Screen -->
        <div class="auth-box" id="resetPasswordScreen" style="display: none;">
            <div class="auth-logo">
                <i class="fas fa-lock"></i>
                <h1>Create New Password</h1>
                <p>Enter your new password below</p>
            </div>

            <div class="alert" id="resetPasswordAlert"></div>

            <div class="form-group">
                <label class="form-label">New Password</label>
                <div class="password-input">
                    <input type="password" class="form-control" id="resetPassword" placeholder="Enter new password">
                    <button type="button" class="toggle-password" onclick="togglePassword('resetPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <div class="password-input">
                    <input type="password" class="form-control" id="resetPasswordConfirm" placeholder="Confirm new password">
                    <button type="button" class="toggle-password" onclick="togglePassword('resetPasswordConfirm')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>

            <div class="auth-footer">
                <span class="auth-link" onclick="showAuthScreen('loginScreen')">Back to Login</span>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="logo">
                    <i class="fas fa-lock"></i>
                    <h1>SecurePass</h1>
                </div>
                <ul class="nav-links">
                    <li><a href="#" class="active" onclick="showDashboardView('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#" onclick="showDashboardView('passwords')"><i class="fas fa-key"></i> All Passwords</a></li>
                    <li><a href="#" onclick="showDashboardView('sharingCenter')"><i class="fas fa-share-alt"></i> Sharing Center</a></li>
                    <li><a href="#" onclick="showDashboardView('familySharing')"><i class="fas fa-user-friends"></i> Family Sharing</a></li>
                    <li><a href="#" onclick="showDashboardView('subscription')"><i class="fas fa-crown"></i> Subscription</a></li>
                    <li><a href="#" onclick="showDashboardView('settings')"><i class="fas fa-cog"></i> Settings</a></li>
                    <li><a href="#" onclick="showDashboardView('security')"><i class="fas fa-shield-alt"></i> Security</a></li>
                    <li><a href="#" onclick="showDashboardView('activityLog')"><i class="fas fa-history"></i> Activity Log</a></li>
                </ul>
                <div class="sidebar-footer">
                    <div class="upgrade-card" id="sidebarUpgradeCard">
                        <div class="upgrade-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="upgrade-title">Upgrade to Premium</div>
                        <div class="upgrade-description">Unlock advanced security features and sharing capabilities</div>
                        <button class="upgrade-btn-sidebar" onclick="showDashboardView('subscription')">
                            Upgrade Now
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="header">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search passwords..." onkeyup="searchPasswords()">
                    </div>
                    <div class="user-actions">
                        <div class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="notification-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="user-profile" onclick="logout()">
                            <img src="" id="userAvatar" alt="User">
                            <span id="userName">User</span>
                        </div>
                    </div>
                </div>

                <!-- Dashboard View -->
                <div id="dashboardView">
                    <!-- Dashboard Cards -->
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Total Passwords</div>
                                <div class="card-icon primary">
                                    <i class="fas fa-key"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalPasswords">0</div>
                            <div class="card-description">Secure passwords stored</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Security Score</div>
                                <div class="card-icon success">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                            </div>
                            <div class="card-value" id="securityScore">0%</div>
                            <div class="card-description" id="securityStatus">Calculating...</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Weak Passwords</div>
                                <div class="card-icon warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="card-value" id="weakPasswords">0</div>
                            <div class="card-description">Needs attention</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Categories</div>
                                <div class="card-icon danger">
                                    <i class="fas fa-folder"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalCategories">0</div>
                            <div class="card-description">Different categories</div>
                        </div>
                    </div>

                    <!-- Recent Passwords -->
                    <div class="password-list">
                        <div class="list-header">
                            <div class="list-title">Recently Added</div>
                            <button class="add-btn" onclick="showAddPasswordModal()">
                                <i class="fas fa-plus"></i> Add Password
                            </button>
                        </div>
                        <div id="recentPasswordsList">
                            <div class="loading" id="recentPasswordsLoading">
                                <div class="spinner"></div>
                                <div>Loading passwords...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Passwords View -->
                <div id="passwordsView" style="display: none;">
                    <div class="password-list">
                        <div class="list-header">
                            <div class="list-title">All Passwords</div>
                            <button class="add-btn" onclick="showAddPasswordModal()">
                                <i class="fas fa-plus"></i> Add Password
                            </button>
                        </div>
                        <div id="allPasswordsList">
                            <div class="loading" id="allPasswordsLoading">
                                <div class="spinner"></div>
                                <div>Loading passwords...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sharing Center View -->
                <div id="sharingCenterView" style="display: none;">
                    <div id="sharingCenterContent">
                        <!-- Content will be dynamically loaded based on user's plan -->
                    </div>
                </div>

                <!-- Family Sharing View -->
                <div id="familySharingView" style="display: none;">
                    <div id="familySharingContent">
                        <!-- Content will be dynamically loaded based on user's plan -->
                    </div>
                </div>

                <!-- Subscription View -->
                <div id="subscriptionView" style="display: none;">
                    <div class="premium-feature">
                        <i class="fas fa-crown premium-icon"></i>
                        <h2 class="premium-title">SecurePass Subscription Plans</h2>
                        <p class="premium-description">Choose the perfect plan for your security needs. You can switch between plans at any time.</p>
                    </div>

                    <div class="pricing-plans">
                        <!-- Free Plan (Only shown for free users) -->
                        <div class="pricing-card" id="freePlanCard" style="display: none;">
                            <h3 class="plan-name">Free</h3>
                            <div class="plan-price">$0</div>
                            <div class="plan-period">forever</div>
                            <ul class="plan-features">
                                <li><i class="fas fa-check"></i> Up to 50 passwords</li>
                                <li><i class="fas fa-check"></i> Basic security features</li>
                                <li><i class="fas fa-check"></i> Single device sync</li>
                                <li><i class="fas fa-times" style="color: var(--danger);"></i> <span style="color: var(--danger);">No sharing features</span></li>
                                <li><i class="fas fa-times" style="color: var(--danger);"></i> <span style="color: var(--danger);">No family sharing</span></li>
                                <li><i class="fas fa-times" style="color: var(--danger);"></i> <span style="color: var(--danger);">Limited support</span></li>
                            </ul>
                            <button class="btn btn-secondary" id="freePlanBtn" disabled>Current Plan</button>
                        </div>

                        <!-- Premium Plan -->
                        <div class="pricing-card featured" id="premiumPlanCard">
                            <h3 class="plan-name">Premium</h3>
                            <div class="plan-price">$4.99</div>
                            <div class="plan-period">per month</div>
                            <ul class="plan-features">
                                <li><i class="fas fa-check"></i> Unlimited passwords</li>
                                <li><i class="fas fa-check"></i> Advanced security features</li>
                                <li><i class="fas fa-check"></i> Multi-device sync</li>
                                <li><i class="fas fa-check"></i> Password sharing</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-times" style="color: var(--danger);"></i> <span style="color: var(--danger);">No family sharing</span></li>
                            </ul>
                            <button class="btn btn-primary" id="premiumPlanBtn" style="padding: 12px 32px; font-size: 15px; font-weight: 600;">
                                Upgrade to Premium
                            </button>
                            <div id="premiumCancelSection" style="display: none; margin-top: 15px;">
                                <button class="btn btn-secondary" id="cancelPremiumBtn" style="width: 100%;">
                                    Cancel Premium Subscription
                                </button>
                            </div>
                        </div>

                        <!-- Family Plan -->
                        <div class="pricing-card" id="familyPlanCard">
                            <h3 class="plan-name">Family</h3>
                            <div class="plan-price">$9.99</div>
                            <div class="plan-period">per month</div>
                            <ul class="plan-features">
                                <li><i class="fas fa-check"></i> Everything in Premium</li>
                                <li><i class="fas fa-check"></i> Up to 10 family members</li>
                                <li><i class="fas fa-check"></i> Family management dashboard</li>
                                <li><i class="fas fa-check"></i> Child account controls</li>
                                <li><i class="fas fa-check"></i> Emergency access</li>
                                <li><i class="fas fa-check"></i> 24/7 premium support</li>
                            </ul>
                            <button class="btn btn-primary" id="familyPlanBtn" style="padding: 12px 32px; font-size: 15px; font-weight: 600;">
                                Choose Family Plan
                            </button>
                            <div id="familyCancelSection" style="display: none; margin-top: 15px;">
                                <button class="btn btn-secondary" id="cancelFamilyBtn" style="width: 100%;">
                                    Cancel Family Subscription
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Current Plan Info -->
                    <div id="currentPlanInfo" class="current-plan-info">
                        <h3>Your Current Plan: <span id="currentPlanDisplay">Free</span></h3>
                        <p id="planDescription">You're currently on the Free plan with basic features.</p>
                        
                        <!-- What You're Missing Section (Only shown for free users) -->
                        <div id="missingFeatures" class="missing-features" style="display: none;">
                            <h4><i class="fas fa-exclamation-triangle"></i> What You're Missing:</h4>
                            <ul>
                                <li>Password sharing with team members</li>
                                <li>Family sharing for up to 10 members</li>
                                <li>Advanced security features</li>
                                <li>Multi-device synchronization</li>
                                <li>Priority customer support</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Security View -->
                <div id="securityView" style="display: none;">
                    <div id="securityContent">
                        <!-- Content will be dynamically loaded based on user's plan -->
                    </div>
                </div>

                <!-- Activity Log View -->
                <div id="activityLogView" style="display: none;">
                    <div id="activityLogContent">
                        <!-- Content will be dynamically loaded based on user's plan -->
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" style="display: none;">
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-title">Appearance</div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Dark Mode</div>
                                    <div class="settings-description">Switch between light and dark themes</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="darkModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="settings-title">Security</div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Biometric Authentication</div>
                                    <div class="settings-description">Use fingerprint or face recognition for quick access</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="biometricToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="biometric-options" id="biometricOptions" style="display: none;">
                                <div class="biometric-option">
                                    <div class="biometric-icon">
                                        <i class="fas fa-fingerprint"></i>
                                    </div>
                                    <div>
                                        <div class="settings-label">Fingerprint</div>
                                        <div class="settings-description">Use your fingerprint to unlock the app</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="fingerprintToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="biometric-option">
                                    <div class="biometric-icon">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                    <div>
                                        <div class="settings-label">Face Recognition</div>
                                        <div class="settings-description">Use face recognition to unlock the app</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="faceRecognitionToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="settings-title">Account</div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Change Password</div>
                                    <div class="settings-description">Update your account password</div>
                                </div>
                                <button class="btn btn-secondary" onclick="showChangePasswordModal()">Change</button>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Change PIN</div>
                                    <div class="settings-description">Update your 4-digit security PIN</div>
                                </div>
                                <button class="btn btn-secondary" onclick="showChangePinModal()">Change</button>
                            </div>
                        </div>


                        <!-- Family Management Section (Only shown for Family plan users) -->
                        <!-- Family Management Section (Only shown for Family plan users) -->
                        <div class="settings-section" id="familyManagementSection" style="display: none;">
                            <div class="settings-title">Family Management</div>
                        
                        <!-- Delete Family Group - Only shown to owner -->
                        <div class="settings-item" id="deleteFamilyItem" style="display: none;">
                                <div>
                                    <div class="settings-label">Delete Family Group</div>
                                    <div class="settings-description">Permanently delete your family group and remove all members. Members will be restored to their previous plans.</div>
                                </div>
                            <button class="danger-btn" onclick="showDeleteFamilyModal()">Delete Family Group</button>
                        </div>
                        
                        <!-- Leave Family Group - Only shown to non-owner parent members -->
                        <div class="settings-item" id="leaveFamilyItem" style="display: none;">
                            <div>
                            <div class="settings-label">Leave Family Group</div>
                            <div class="settings-description">Leave the family group. You'll be restored to your previous plan.</div>
                            </div>
                            <button class="danger-btn" onclick="showLeaveFamilyModal()">Leave Family Group</button>
                        </div>

                        <!-- Child Account Message - Only shown to child accounts -->
                        <div class="settings-item" id="childAccountMessage" style="display: none;">
                            <div>
                            <div class="settings-label">Child Account</div>
                            <div class="settings-description">As a child account, you cannot leave the family. Please ask the family owner to remove you if needed.</div>
                            </div>
                        </div>
                        </div>

                        <div class="danger-zone">
                            <div class="settings-title">Danger Zone</div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Delete Account</div>
                                    <div class="settings-description">Permanently delete your account and all stored passwords</div>
                                </div>
                                <button class="danger-btn" onclick="showDeleteAccountModal()">Delete Account</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Password Modal -->
    <div class="modal" id="addPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Password</div>
                <button class="close-modal" onclick="closeModal('addPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Website/Service</label>
                    <input type="text" class="form-control" id="passwordWebsite" placeholder="e.g., Google">
                </div>
                <div class="form-group">
                    <label class="form-label">Username/Email</label>
                    <input type="text" class="form-control" id="passwordUsername" placeholder="e.g., john@gmail.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-input">
                        <input type="password" class="form-control" id="passwordValue" placeholder="Enter password">
                        <button type="button" class="toggle-password" onclick="togglePassword('passwordValue')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="security-indicator">
                        <div class="security-strength" id="passwordStrength"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="passwordCategory">
                        <option value="Personal">Personal</option>
                        <option value="Work">Work</option>
                        <option value="Social">Social</option>
                        <option value="Banking">Banking</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="text" class="form-control" id="passwordUrl" placeholder="https://">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="passwordNotes" rows="3" placeholder="Add any notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPasswordModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addPassword()">Save Password</button>
            </div>
        </div>
    </div>


    <!-- Add to Family Vault Modal -->
    <div class="modal" id="addFamilyVaultModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add to Family Vault</div>
                <button class="close-modal" onclick="closeModal('addFamilyVaultModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Website/Service</label>
                    <input type="text" class="form-control" id="familyVaultWebsite" placeholder="e.g., Netflix">
                </div>
                <div class="form-group">
                    <label class="form-label">Username/Email</label>
                    <input type="text" class="form-control" id="familyVaultUsername" placeholder="e.g., family@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-input">
                        <input type="password" class="form-control" id="familyVaultPassword" placeholder="Enter password">
                        <button type="button" class="toggle-password" onclick="togglePassword('familyVaultPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="security-indicator">
                        <div class="security-strength" id="familyVaultPasswordStrength"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Share With</label>
                    <select class="form-control" id="familyVaultShareWith">
                        <option value="all">All Family Members</option>
                        <option value="parents">Parents Only</option>
                        <option value="specific">Specific Member</option>
                    </select>
                </div>
                <div class="form-group" id="specificMemberGroup" style="display: none;">
                    <label class="form-label">Select Family Member</label>
                    <select class="form-control" id="familyVaultSpecificMember">
                        <!-- Dynamically populated -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="familyVaultCategory">
                        <option value="Entertainment">Entertainment</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Travel">Travel</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="text" class="form-control" id="familyVaultUrl" placeholder="https://">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="familyVaultNotes" rows="3" placeholder="Add any notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addFamilyVaultModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addToFamilyVault()">Add to Family Vault</button>
            </div>
        </div>
    </div>

    <!-- Share to Family Vault Modal -->
    <div class="modal" id="shareToFamilyVaultModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Share to Family Vault</div>
                <button class="close-modal" onclick="closeModal('shareToFamilyVaultModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Share With</label>
                    <select class="form-control" id="shareToFamilyVaultWith">
                        <option value="all">All Family Members</option>
                        <option value="parents">Parents Only</option>
                        <option value="specific">Specific Member</option>
                    </select>
                </div>
                <div class="form-group" id="shareSpecificMemberGroup" style="display: none;">
                    <label class="form-label">Select Family Member</label>
                    <select class="form-control" id="shareToFamilyVaultSpecificMember">
                        <!-- Dynamically populated -->
                    </select>
                </div>
                <div class="share-options">
                    <h4>Family Vault Sharing</h4>
                    <p style="font-size: 14px; color: var(--gray); margin-bottom: 12px;">
                        Share this password with your family members. They will need their PIN to view it.
                    </p>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-shield-alt" style="color: var(--info);"></i>
                        <span style="font-size: 14px; color: var(--gray);">
                            All family members need their PIN to view vault passwords
                        </span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('shareToFamilyVaultModal')">Cancel</button>
                <button class="btn btn-primary" onclick="shareToFamilyVault()">Share to Vault</button>
            </div>
        </div>
    </div>

    <!-- PIN Verification Modal -->
    <div class="modal" id="pinModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="pinModalTitle">Enter PIN to View Password</div>
                <button class="close-modal" onclick="closeModal('pinModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="pinModalDescription">For security reasons, please enter your PIN to view this password.</p>
                <div class="pin-inputs">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="verifyPin()" style="width: 100%;">Verify PIN</button>
                </div>
                <p style="text-align: center; font-size: 14px; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> Your PIN is required to decrypt passwords
                </p>
            </div>
        </div>
    </div>

    <!-- Password Details Modal -->
    <div class="modal" id="passwordDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="passwordDetailsTitle">Password Details</div>
                <button class="close-modal" onclick="closeModal('passwordDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailWebsite"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailUsername"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-input">
                        <input type="password" class="form-control" id="detailPassword" readonly>
                        <button type="button" class="toggle-password" onclick="togglePassword('detailPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="toggle-password" onclick="copyPassword()" style="right: 45px;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailCategory"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailUrl"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <div class="form-control" style="background: var(--gray-light); min-height: 80px;" id="detailNotes"></div>
                </div>
                <div id="sharedPasswordInfo" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Shared By</label>
                        <div class="form-control" style="background: var(--gray-light);" id="detailSharedBy"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('passwordDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    
    <!-- PIN Verification Modal -->
    <div class="modal" id="pinModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="pinModalTitle">Enter PIN to View Password</div>
                <button class="close-modal" onclick="closeModal('pinModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="pinModalDescription">For security reasons, please enter your PIN to view this password.</p>
                <div class="pin-inputs">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                    <input type="password" class="pin-input" maxlength="1" pattern="[0-9]">
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="verifyPin()" style="width: 100%;">Verify PIN</button>
                </div>
                <p style="text-align: center; font-size: 14px; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> Your PIN is required to decrypt passwords
                </p>
            </div>
        </div>
    </div>

    <!-- Password Details Modal -->
    <div class="modal" id="passwordDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="passwordDetailsTitle">Password Details</div>
                <button class="close-modal" onclick="closeModal('passwordDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailWebsite"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailUsername"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-input">
                        <input type="password" class="form-control" id="detailPassword" readonly>
                        <button type="button" class="toggle-password" onclick="togglePassword('detailPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="toggle-password" onclick="copyPassword()" style="right: 45px;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailCategory"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <div class="form-control" style="background: var(--gray-light);" id="detailUrl"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <div class="form-control" style="background: var(--gray-light); min-height: 80px;" id="detailNotes"></div>
                </div>
                <div id="sharedPasswordInfo" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Shared By</label>
                        <div class="form-control" style="background: var(--gray-light);" id="detailSharedBy"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('passwordDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Share Password Modal -->
    <div class="modal" id="sharePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Share Password</div>
                <button class="close-modal" onclick="closeModal('sharePasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Recipient Email</label>
                    <input type="email" class="form-control" id="shareEmail" placeholder="Enter recipient's email">
                </div>
                <div class="form-group">
                    <label class="form-label">Access Level</label>
                    <select class="form-control" id="shareAccessLevel">
                        <option value="view">View Only</option>
                        <option value="edit">Can Edit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Expires In (Optional)</label>
                    <select class="form-control" id="shareExpires">
                        <option value="">Never</option>
                        <option value="24">24 Hours</option>
                        <option value="168">7 Days</option>
                        <option value="720">30 Days</option>
                    </select>
                </div>
                <div class="share-options">
                    <h4>Sharing Options</h4>
                    <p style="font-size: 14px; color: var(--gray); margin-bottom: 12px;">
                        The recipient will be able to access this password with the permissions you set.
                    </p>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle" style="color: var(--info);"></i>
                        <span style="font-size: 14px; color: var(--gray);">
                            Requires recipient to have a SecurePass account
                        </span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('sharePasswordModal')">Cancel</button>
                <button class="btn btn-primary" onclick="sharePassword()">Share Password</button>
            </div>
        </div>
    </div>

    <!-- Create Family Modal -->
    <div class="modal" id="createFamilyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Family Group</div>
                <button class="close-modal" onclick="closeModal('createFamilyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Family Group Name</label>
                    <input type="text" class="form-control" id="familyName" placeholder="Enter family group name" value="My Family">
                </div>
                <div class="share-options">
                    <h4>Family Sharing Benefits</h4>
                    <ul style="font-size: 14px; color: var(--gray); padding-left: 20px; margin: 12px 0;">
                        <li>Share passwords securely with up to 10 family members</li>
                        <li>Parental controls for child accounts</li>
                        <li>Emergency access for trusted family members</li>
                        <li>Family vault for shared accounts</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createFamilyModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createFamilyGroup()">Create Family Group</button>
            </div>
        </div>
    </div>

    <!-- Invite Family Member Modal -->
    <div class="modal" id="inviteFamilyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Invite Family Member</div>
                <button class="close-modal" onclick="closeModal('inviteFamilyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="familyInviteEmail" placeholder="Enter family member's email">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-control" id="familyMemberRole">
                        <option value="parent">Parent (Full Access)</option>
                        <option value="child">Child (Limited Access)</option>
                    </select>
                </div>
                <div class="share-options">
                    <h4>Role Permissions</h4>
                    <div id="rolePermissions" style="font-size: 14px; color: var(--gray);">
                        <!-- Role permissions will be dynamically updated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('inviteFamilyModal')">Cancel</button>
                <button class="btn btn-primary" onclick="inviteFamilyMember()">Send Invitation</button>
            </div>
        </div>
    </div>

    <!-- Delete Family Modal -->
    <div class="modal" id="deleteFamilyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Delete Family Group</div>
                <button class="close-modal" onclick="closeModal('deleteFamilyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone. All family members will be removed and the family group will be permanently deleted.
                </div>
                <div class="form-group">
                    <label class="form-label">Enter your password to confirm</label>
                    <div class="password-input">
                        <input type="password" class="form-control" id="deleteFamilyPassword" placeholder="Enter your password">
                        <button type="button" class="toggle-password" onclick="togglePassword('deleteFamilyPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Type "DELETE FAMILY" to confirm</label>
                    <input type="text" class="form-control" id="deleteFamilyConfirmation" placeholder="Type DELETE FAMILY">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteFamilyModal')">Cancel</button>
                <button class="btn btn-danger" onclick="deleteFamilyGroup()">Delete Family Group</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal" id="deleteAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Delete Account</div>
                <button class="close-modal" onclick="closeModal('deleteAccountModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone. All your passwords and data will be permanently deleted.
                </div>
                <div class="form-group">
                    <label class="form-label">Enter your password to confirm</label>
                    <div class="password-input">
                        <input type="password" class="form-control" id="deleteAccountPassword" placeholder="Enter your password">
                        <button type="button" class="toggle-password" onclick="togglePassword('deleteAccountPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Type "DELETE" to confirm</label>
                    <input type="text" class="form-control" id="deleteConfirmation" placeholder="Type DELETE">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteAccountModal')">Cancel</button>
                <button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Success Notification -->
    <div class="notification" id="successNotification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationMessage">Password saved successfully!</span>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://securepass-backend.devbytho.workers.dev';
        let currentUser = null;
        let authToken = null;
        let currentPasswordId = null;
        let allPasswords = [];
        let currentAction = 'view'; // 'view', 'copy', or 'cancel_subscription'
        let currentPasswordForSharing = null;
        let isSharedPassword = false;
        let isFamilyVaultPassword = false;

        // DOM Elements
        const authScreens = {
            login: document.getElementById('loginScreen'),
            register: document.getElementById('registerScreen'),
            verify: document.getElementById('verifyScreen'),
            forgotPassword: document.getElementById('forgotPasswordScreen'),
            resetPassword: document.getElementById('resetPasswordScreen')
        };

        const dashboardViews = {
            dashboard: document.getElementById('dashboardView'),
            passwords: document.getElementById('passwordsView'),
            sharingCenter: document.getElementById('sharingCenterView'),
            familySharing: document.getElementById('familySharingView'),
            subscription: document.getElementById('subscriptionView'),
            security: document.getElementById('securityView'),
            activityLog: document.getElementById('activityLogView'),
            settings: document.getElementById('settingsView')
        };

        // Utility Functions
        function showAuthScreen(screenName) {
            Object.values(authScreens).forEach(screen => {
                screen.style.display = 'none';
            });
            document.getElementById(screenName).style.display = 'block';
        }

        function showDashboardView(viewName) {
            console.log('Switching to view:', viewName);
            
            // Hide all views
            Object.values(dashboardViews).forEach(view => {
                if (view) view.style.display = 'none';
            });
            
            // Show target view
            const targetView = document.getElementById(viewName + 'View');
            if (targetView) {
                targetView.style.display = 'block';
                console.log('View displayed:', viewName + 'View');
            }
            
            // Update active nav link
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load appropriate data based on view
            if (viewName === 'dashboard') {
                console.log('Updating dashboard view with current passwords...');
                updatePasswordLists();
                loadDashboardData();
            } else if (viewName === 'passwords') {
                console.log('Updating passwords view with current passwords...');
                updatePasswordLists();
            }
            
            // Update subscription view if needed
            if (viewName === 'subscription') {
                updateSubscriptionView(currentUser?.plan || 'free');
            }
            
            // Update settings view to show/hide family management
            if (viewName === 'settings') {
                updateSettingsView();
            }
            
            // Load content based on user's plan
            loadViewContent(viewName);
        }

        function updateSettingsView() {
  const familySection = document.getElementById('familyManagementSection');
  const deleteFamilyItem = document.getElementById('deleteFamilyItem');
  const leaveFamilyItem = document.getElementById('leaveFamilyItem');
  const childAccountMessage = document.getElementById('childAccountMessage');
  
  if (currentUser?.plan === 'family') {
    familySection.style.display = 'block';
    
    // Check if user is family owner and their role
    checkFamilyOwnershipAndRole().then(({ isOwner, role }) => {
      if (isOwner) {
        deleteFamilyItem.style.display = 'flex';
        leaveFamilyItem.style.display = 'none';
        childAccountMessage.style.display = 'none';
      } else if (role === 'parent') {
        deleteFamilyItem.style.display = 'none';
        leaveFamilyItem.style.display = 'flex';
        childAccountMessage.style.display = 'none';
      } else {
        // Child account - show message only
        deleteFamilyItem.style.display = 'none';
        leaveFamilyItem.style.display = 'none';
        childAccountMessage.style.display = 'flex';
      }
    }).catch(error => {
      console.error('Error checking family ownership:', error);
      // Default to showing leave option if we can't determine ownership
      deleteFamilyItem.style.display = 'none';
      leaveFamilyItem.style.display = 'flex';
      childAccountMessage.style.display = 'none';
    });
  } else {
    familySection.style.display = 'none';
  }
}
    async function checkFamilyOwnershipAndRole() {
  try {
    const result = await apiCall('/api/family');
    if (result.family) {
      const userMember = result.family.members.find(member => member.id === currentUser.id);
      return {
        isOwner: result.family.owner_id === currentUser.id,
        role: userMember ? userMember.role : 'child'
      };
    }
    return { isOwner: false, role: 'child' };
  } catch (error) {
    console.error('Error checking family ownership:', error);
    return { isOwner: false, role: 'child' };
  }
}

        function loadViewContent(viewName) {
            const userPlan = currentUser?.plan || 'free';
            
            switch(viewName) {
                case 'sharingCenter':
                    loadSharingCenterContent(userPlan);
                    break;
                case 'familySharing':
                    loadFamilySharingContent(userPlan);
                    break;
                case 'security':
                    loadSecurityContent(userPlan);
                    break;
                case 'activityLog':
                    loadActivityLogContent(userPlan);
                    break;
            }
        }

        async function loadSharingCenterContent(userPlan) {
            const contentDiv = document.getElementById('sharingCenterContent');
            
            if (userPlan === 'free') {
                contentDiv.innerHTML = `
                    <div class="feature-access">
                        <i class="fas fa-share-alt feature-access-icon"></i>
                        <h2 class="feature-access-title">Sharing Center</h2>
                        <p class="feature-access-description">Share passwords securely with team members and trusted contacts. Collaborate without compromising security.</p>
                        <div class="required-plan">Requires Premium Plan</div>
                        <button class="btn btn-primary" style="margin-top: 24px; padding: 12px 32px; font-size: 15px; font-weight: 600;" onclick="showDashboardView('subscription')">
                            Upgrade to Premium
                        </button>
                    </div>
                    <div class="premium-benefits">
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 class="benefit-title">Team Sharing</h3>
                            <p class="benefit-description">Share passwords securely with your team members with customizable access levels and permissions.</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 class="benefit-title">Temporary Access</h3>
                            <p class="benefit-description">Grant time-limited access to shared passwords that automatically revokes when the time expires.</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-eye-slash"></i>
                            </div>
                            <h3 class="benefit-title">Hide Passwords</h3>
                            <p class="benefit-description">Share access without revealing the actual password for maximum security and control.</p>
                        </div>
                    </div>
                `;
            } else {
                try {
                    const result = await apiCall('/api/shared-passwords');
                    const sharedWithMe = result.sharedWithMe || [];
                    const sharedByMe = result.sharedByMe || [];

                    contentDiv.innerHTML = `
                        <div class="password-list">
                            <div class="list-header">
                                <div class="list-title">Shared With Me</div>
                            </div>
                            <div id="sharedWithMeList">
                                ${sharedWithMe.length === 0 ? `
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <h3>No passwords shared with you</h3>
                                        <p>When someone shares a password with you, it will appear here</p>
                                    </div>
                                ` : sharedWithMe.map(share => `
                                    <div class="password-item">
                                        <div class="password-icon">${share.website.charAt(0).toUpperCase()}</div>
                                        <div class="password-details">
                                            <div class="password-name">${share.website}</div>
                                            <div class="password-username">Shared by: ${share.shared_by_name}</div>
                                        </div>
                                        <div class="password-actions">
                                            <button class="action-btn view-password" data-id="${share.id}" data-shared="true">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-btn copy-password" data-id="${share.id}" data-shared="true">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-top: 32px;">
                            <div class="list-header">
                                <div class="list-title">Shared By Me</div>
                                <button class="add-btn" onclick="showSharePasswordModal()">
                                    <i class="fas fa-share-alt"></i> Share Password
                                </button>
                            </div>
                            <div id="sharedByMeList">
                                ${sharedByMe.length === 0 ? `
                                    <div class="empty-state" style="padding: 30px 20px;">
                                        <i class="fas fa-share-alt"></i>
                                        <h3>No passwords shared yet</h3>
                                        <p>Start sharing passwords with your team members</p>
                                    </div>
                                ` : sharedByMe.map(share => `
                                    <div class="password-item">
                                        <div class="password-icon">${share.website.charAt(0).toUpperCase()}</div>
                                        <div class="password-details">
                                            <div class="password-name">${share.website}</div>
                                            <div class="password-username">Shared with: ${share.shared_with_name}</div>
                                        </div>
                                        <div class="password-actions">
                                            <button class="action-btn view-password" data-id="${share.password_id}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-btn copy-password" data-id="${share.password_id}">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="action-btn" onclick="revokeShare(${share.id})" title="Revoke Share">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;

                    // Add event listeners for shared password actions
                    setTimeout(() => {
                        document.querySelectorAll('#sharedWithMeList .view-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const shareId = this.getAttribute('data-id');
                                const isShared = this.getAttribute('data-shared') === 'true';
                                showPasswordDetails(shareId, isShared);
                            });
                        });

                        document.querySelectorAll('#sharedWithMeList .copy-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const shareId = this.getAttribute('data-id');
                                const isShared = this.getAttribute('data-shared') === 'true';
                                copyPasswordToClipboard(shareId, isShared);
                            });
                        });

                        document.querySelectorAll('#sharedByMeList .view-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const passwordId = this.getAttribute('data-id');
                                showPasswordDetails(passwordId);
                            });
                        });

                        document.querySelectorAll('#sharedByMeList .copy-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const passwordId = this.getAttribute('data-id');
                                copyPasswordToClipboard(passwordId);
                            });
                        });

                    }, 100);

                } catch (error) {
                    console.error('Error loading shared passwords:', error);
                    contentDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error loading shared passwords</h3>
                            <p>Please try again later</p>
                        </div>
                    `;
                }
            }
        }

        async function loadFamilySharingContent(userPlan) {
            const contentDiv = document.getElementById('familySharingContent');
            
            // Load pending invitations for ALL users
            let pendingInvitations = [];
            try {
                const invitationsResult = await apiCall('/api/family/my-invitations');
                pendingInvitations = invitationsResult.invitations || [];
            } catch (error) {
                console.error('Error loading invitations:', error);
            }

            // Invitations section - shown to ALL users
            const invitationsSection = pendingInvitations.length > 0 ? `
                <div class="password-list" style="margin-bottom: 32px;">
                    <div class="list-header">
                        <div class="list-title">Pending Family Invitations</div>
                        <div class="card-description">You have ${pendingInvitations.length} pending invitation(s)</div>
                    </div>
                    <div id="pendingInvitationsList">
                        ${pendingInvitations.map(invite => `
                            <div class="password-item">
                                <div class="password-icon" style="background: var(--warning);">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="password-details">
                                    <div class="password-name">${invite.family_name}</div>
                                    <div class="password-username">
                                        Invited by: ${invite.owner_name} (${invite.owner_email})
                                    </div>
                                    <div class="password-username">
                                        Role: ${invite.role}  Expires: ${new Date(invite.expires_at).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="password-actions">
                                    <button class="action-btn accept-invite" data-token="${invite.token}" title="Accept Invitation">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                    </button>
                                    <button class="action-btn decline-invite" data-token="${invite.token}" title="Decline Invitation">
                                        <i class="fas fa-times" style="color: var(--danger);"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : `
                <div class="empty-state" style="margin-bottom: 32px;">
                    <i class="fas fa-envelope-open"></i>
                    <h3>No pending invitations</h3>
                    <p>When someone invites you to their family, it will appear here</p>
                </div>
            `;

            // Free/Premium users see only invitations
            if (userPlan === 'free' || userPlan === 'premium') {
                contentDiv.innerHTML = `
                    ${invitationsSection}
                    
                    <div class="feature-access">
                        <i class="fas fa-user-friends feature-access-icon"></i>
                        <h2 class="feature-access-title">Family Sharing</h2>
                        <p class="feature-access-description">
                            ${userPlan === 'free' 
                                ? 'You can join family groups when invited. Upgrade to Family plan to create your own family and invite members.' 
                                : 'You can join family groups when invited. Upgrade to Family plan to create your own family and invite members.'}
                        </p>
                        ${userPlan === 'free' ? `
                            <div class="required-plan">Create Family: Requires Family Plan</div>
                            <button class="btn btn-primary" style="margin-top: 24px; padding: 12px 32px; font-size: 15px; font-weight: 600;" onclick="showDashboardView('subscription')">
                                Upgrade to Family
                            </button>
                        ` : ''}
                    </div>
                `;
            } 
            // Family plan users see full management
            else if (userPlan === 'family') {
                try {
                    const result = await apiCall('/api/family');
                    const family = result.family;
                    
                    // Handle case where user has family plan but no family group
                    if (!family) {
                        contentDiv.innerHTML = `
                            ${invitationsSection}
                            
                            <div class="feature-access">
                                <i class="fas fa-home feature-access-icon"></i>
                                <h2 class="feature-access-title">Create Your Family Group</h2>
                                <p class="feature-access-description">Start by creating a family group to share passwords securely with your family members.</p>
                                <button class="btn btn-primary" style="margin-top: 24px; padding: 12px 32px; font-size: 15px; font-weight: 600;" onclick="showCreateFamilyModal()">
                                    Create Family Group
                                </button>
                            </div>
                        `;
                        return;
                    }

                    // Load family vault passwords
                    const vaultResult = await apiCall('/api/family/vault/passwords');
                    const vaultPasswords = vaultResult.passwords || [];

                    const emergencyAccessSection = family.emergencyAccess && family.emergencyAccess.enabled ? `
                        <div class="emergency-access-banner">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                            <strong>Emergency Access Active</strong>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">
                                All family members have access to shared passwords for emergency purposes.
                            </p>
                            <button class="btn btn-secondary" style="margin-top: 12px; background: rgba(255,255,255,0.2);" onclick="disableEmergencyAccess()">
                                Disable Emergency Access
                            </button>
                        </div>
                    ` : '';

                    contentDiv.innerHTML = `
                        ${invitationsSection}
                        ${emergencyAccessSection}
                        
                        <div class="password-list">
                            <div class="list-header">
                                <div class="list-title">Family Members</div>
                                <button class="add-btn" onclick="showInviteFamilyModal()">
                                    <i class="fas fa-user-plus"></i> Invite Member
                                </button>
                            </div>
                            <div id="familyMembersList">
                                ${family.members.map(member => `
                                    <div class="family-member-card">
                                        <div class="family-member-avatar">
                                            ${member.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div class="family-member-info">
                                            <div class="family-member-name">${member.name}</div>
                                            <div class="family-member-role">
                                                ${member.role} ${member.id === family.owner_id ? '(Owner)' : ''}
                                            </div>
                                        </div>
                                        ${member.id !== family.owner_id && family.owner_id === currentUser.id ? `
                                            <div class="password-actions">
                                                <button class="action-btn" onclick="removeFamilyMember(${member.id})" title="Remove Member">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-top: 32px;">
                            <div class="list-header">
                                <div class="list-title">Family Vault</div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="add-btn" onclick="showAddFamilyVaultModal()">
                                        <i class="fas fa-plus"></i> Add to Vault
                                    </button>
                                    ${family.owner_id === currentUser.id ? `
                                        <button class="add-btn" onclick="enableEmergencyAccess()">
                                            <i class="fas fa-shield-alt"></i> Enable Emergency Access
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div id="familyVaultContent">
                                ${vaultPasswords.length === 0 ? `
                                    <div class="empty-state" style="padding: 30px 20px;">
                                        <i class="fas fa-home"></i>
                                        <h3>Family vault is empty</h3>
                                        <p>Add passwords to the family vault to share with family members</p>
                                    </div>
                                ` : vaultPasswords.map(password => `
                                    <div class="password-item">
                                        <div class="password-icon">${password.website.charAt(0).toUpperCase()}</div>
                                        <div class="password-details">
                                            <div class="password-name">${password.website}</div>
                                            <div class="password-username">
                                                ${password.username}  Added by: ${password.added_by_name}
                                            </div>
                                            <div class="password-username" style="color: var(--info); font-size: 12px;">
                                                <i class="fas fa-users"></i> ${password.share_with_name}
                                            </div>
                                        </div>
                                        <div class="password-actions">
                                            <button class="action-btn view-password" data-id="${password.id}" data-family-vault="true">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-btn copy-password" data-id="${password.id}" data-family-vault="true">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            ${password.added_by_user_id === currentUser.id || family.owner_id === currentUser.id ? `
                                                <button class="action-btn delete-password" data-id="${password.id}" data-family-vault="true">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;

                    // Add event listeners for family vault actions
                    setTimeout(() => {
                        document.querySelectorAll('#familyVaultContent .view-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const passwordId = this.getAttribute('data-id');
                                const isFamilyVault = this.getAttribute('data-family-vault') === 'true';
                                showFamilyVaultPasswordDetails(passwordId);
                            });
                        });

                        document.querySelectorAll('#familyVaultContent .copy-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const passwordId = this.getAttribute('data-id');
                                const isFamilyVault = this.getAttribute('data-family-vault') === 'true';
                                copyFamilyVaultPassword(passwordId);
                            });
                        });

                        document.querySelectorAll('#familyVaultContent .delete-password').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const passwordId = this.getAttribute('data-id');
                                const isFamilyVault = this.getAttribute('data-family-vault') === 'true';
                                removeFromFamilyVault(passwordId);
                            });
                        });

                    }, 100);

                } catch (error) {
                    console.error('Error loading family data:', error);
                    contentDiv.innerHTML = `
                        ${invitationsSection}
                        
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error loading family data</h3>
                            <p>Please try again later</p>
                        </div>
                    `;
                }
            }
        }

        function loadSecurityContent(userPlan) {
            const contentDiv = document.getElementById('securityContent');
            
            if (userPlan === 'free') {
                contentDiv.innerHTML = `
                    <div class="feature-access">
                        <i class="fas fa-shield-alt feature-access-icon"></i>
                        <h2 class="feature-access-title">Advanced Security</h2>
                        <p class="feature-access-description">Enhanced security features to protect your digital life with enterprise-grade protection.</p>
                        <div class="required-plan">Requires Premium Plan</div>
                        <button class="btn btn-primary" style="margin-top: 24px; padding: 12px 32px; font-size: 15px; font-weight: 600;" onclick="showDashboardView('subscription')">
                            Upgrade to Premium
                        </button>
                    </div>
                    <div class="premium-benefits">
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-fingerprint"></i>
                            </div>
                            <h3 class="benefit-title">Biometric Lock</h3>
                            <p class="benefit-description">Secure your vault with fingerprint or face recognition for quick and secure access.</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <h3 class="benefit-title">Auto-Logout</h3>
                            <p class="benefit-description">Automatic logout after inactivity for added security and peace of mind.</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <h3 class="benefit-title">Security Alerts</h3>
                            <p class="benefit-description">Get notified of suspicious activity, breaches, and security recommendations.</p>
                        </div>
                    </div>
                `;
            } else if (userPlan === 'premium' || userPlan === 'family') {
                contentDiv.innerHTML = `
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-title">Advanced Security Features</div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Biometric Authentication</div>
                                    <div class="settings-description">Use fingerprint or face recognition for quick access</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="advancedBiometricToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Auto-Logout</div>
                                    <div class="settings-description">Automatically log out after 15 minutes of inactivity</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoLogoutToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Security Alerts</div>
                                    <div class="settings-description">Receive notifications for suspicious activity</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="securityAlertsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-title">Security Reports</div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Last Security Scan</div>
                                    <div class="settings-description">Completed 2 hours ago - No issues found</div>
                                </div>
                                <button class="btn btn-secondary">Run Scan</button>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-label">Breach Monitoring</div>
                                    <div class="settings-description">Monitoring 15 passwords for data breaches</div>
                                </div>
                                <button class="btn btn-secondary">View Report</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function loadActivityLogContent(userPlan) {
            const contentDiv = document.getElementById('activityLogContent');
            
            if (userPlan === 'free') {
                contentDiv.innerHTML = `
                    <div class="feature-access">
                        <i class="fas fa-history feature-access-icon"></i>
                        <h2 class="feature-access-title">Activity Log</h2>
                        <p class="feature-access-description">Monitor all access and changes to your password vault with detailed audit trails.</p>
                        <div class="required-plan">Requires Premium Plan</div>
                        <button class="btn btn-primary" style="margin-top: 24px; padding: 12px 32px; font-size: 15px; font-weight: 600;" onclick="showDashboardView('subscription')">
                            Upgrade to Premium
                        </button>
                    </div>
                    <div class="premium-benefits">
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-list-alt"></i>
                            </div>
                            <h3 class="benefit-title">Detailed Logs</h3>
                            <p class="benefit-description">Complete history of all vault activities, access attempts, and changes made.</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <h3 class="benefit-title">Location Tracking</h3>
                            <p class="benefit-description">See where your vault was accessed from with detailed geographic information.</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <h3 class="benefit-title">Export Reports</h3>
                            <p class="benefit-description">Download comprehensive activity reports for auditing and compliance purposes.</p>
                        </div>
                    </div>
                `;
            } else if (userPlan === 'premium' || userPlan === 'family') {
                contentDiv.innerHTML = `
                    <div class="password-list">
                        <div class="list-header">
                            <div class="list-title">Recent Activity</div>
                            <button class="btn btn-secondary">
                                <i class="fas fa-download"></i> Export Log
                            </button>
                        </div>
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <h3>No activity recorded</h3>
                            <p>Your activity log will appear here as you use SecurePass</p>
                        </div>
                    </div>
                    <div style="margin-top: 32px;">
                        <h3 style="margin-bottom: 16px;">Activity Statistics</h3>
                        <div class="dashboard-cards">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Today</div>
                                    <div class="card-icon primary">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                </div>
                                <div class="card-value">0</div>
                                <div class="card-description">Activities</div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">This Week</div>
                                    <div class="card-icon success">
                                        <i class="fas fa-calendar-week"></i>
                                    </div>
                                </div>
                                <div class="card-value">0</div>
                                <div class="card-description">Activities</div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">This Month</div>
                                    <div class="card-icon warning">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                </div>
                                <div class="card-value">0</div>
                                <div class="card-description">Activities</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function showAlert(elementId, message, type = 'error') {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentNode.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('successNotification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Dark Mode Functions
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            
            // Update theme toggle icon
            const themeIcon = document.querySelector('#themeToggle i');
            if (isDarkMode) {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }

        function initializeDarkMode() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
                document.querySelector('#themeToggle i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.checked = false;
                document.querySelector('#themeToggle i').className = 'fas fa-moon';
            }
        }

        // Biometric Functions
        function toggleBiometricOptions() {
            const biometricToggle = document.getElementById('biometricToggle');
            const biometricOptions = document.getElementById('biometricOptions');
            
            if (biometricToggle.checked) {
                biometricOptions.style.display = 'block';
                // Check if WebAuthn is supported
                if (!window.PublicKeyCredential) {
                    showNotification('Biometric authentication is not supported on this device/browser', 'error');
                    biometricToggle.checked = false;
                    biometricOptions.style.display = 'none';
                    return;
                }
                
                // Initialize biometric options based on device capabilities
                initializeBiometricOptions();
            } else {
                biometricOptions.style.display = 'none';
                // Disable all biometric options
                document.getElementById('fingerprintToggle').checked = false;
                document.getElementById('faceRecognitionToggle').checked = false;
            }
        }

        function initializeBiometricOptions() {
            // In a real implementation, you would check device capabilities
            // For this demo, we'll simulate both options being available
            document.getElementById('fingerprintToggle').disabled = false;
            document.getElementById('faceRecognitionToggle').disabled = false;
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    // For family endpoint, don't throw error for 404 - let the frontend handle it
                    if (endpoint === '/api/family' && response.status === 404) {
                        return { family: null }; // Return empty family instead of throwing error
                    }
                    throw new Error(data.error || 'API request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Get user's current plan from database
        async function getUserPlan() {
            try {
                const result = await apiCall('/api/user/plan');
                return result.plan || 'free';
            } catch (error) {
                console.error('Error getting user plan:', error);
                return 'free';
            }
        }

        // Update subscription view based on current plan
        function updateSubscriptionView(currentPlan) {
            const freePlanCard = document.getElementById('freePlanCard');
            const premiumPlanCard = document.getElementById('premiumPlanCard');
            const familyPlanCard = document.getElementById('familyPlanCard');
            
            const premiumPlanBtn = document.getElementById('premiumPlanBtn');
            const familyPlanBtn = document.getElementById('familyPlanBtn');
            
            const premiumCancelSection = document.getElementById('premiumCancelSection');
            const familyCancelSection = document.getElementById('familyCancelSection');
            
            const currentPlanDisplay = document.getElementById('currentPlanDisplay');
            const planDescription = document.getElementById('planDescription');
            const missingFeatures = document.getElementById('missingFeatures');

            // Remove featured styling from all cards initially
            premiumPlanCard.classList.remove('featured');
            familyPlanCard.classList.remove('featured');

            // Reset all buttons and sections
            premiumPlanBtn.style.display = 'block';
            familyPlanBtn.style.display = 'block';
            premiumCancelSection.style.display = 'none';
            familyCancelSection.style.display = 'none';
            
            // Show/hide free plan and missing features based on current plan
            if (currentPlan === 'free') {
                freePlanCard.style.display = 'block';
                missingFeatures.style.display = 'block';
                currentPlanDisplay.textContent = 'Free';
                planDescription.textContent = 'You\'re currently on the Free plan with basic features.';
                
                // Add featured styling to premium plan
                premiumPlanCard.classList.add('featured');
                
                premiumPlanBtn.textContent = 'Upgrade to Premium';
                premiumPlanBtn.onclick = () => upgradePlan('premium');
                
                familyPlanBtn.textContent = 'Choose Family Plan';
                familyPlanBtn.onclick = () => upgradePlan('family');
                
            } else if (currentPlan === 'premium') {
                freePlanCard.style.display = 'none';
                missingFeatures.style.display = 'none';
                currentPlanDisplay.textContent = 'Premium';
                planDescription.textContent = 'You\'re enjoying all Premium features. You can upgrade to Family or cancel your subscription.';
                
                // Add featured styling to family plan
                familyPlanCard.classList.add('featured');
                
                premiumPlanBtn.style.display = 'none';
                premiumCancelSection.style.display = 'block';
                
                familyPlanBtn.textContent = 'Switch to Family Plan';
                familyPlanBtn.onclick = () => upgradePlan('family');
                
                document.getElementById('cancelPremiumBtn').onclick = () => cancelSubscription('premium');
                
            } else if (currentPlan === 'family') {
                freePlanCard.style.display = 'none';
                missingFeatures.style.display = 'none';
                currentPlanDisplay.textContent = 'Family';
                planDescription.textContent = 'You\'re enjoying all Family features. You can switch to Premium or cancel your subscription.';
                
                // Add featured styling to premium plan
                premiumPlanCard.classList.add('featured');
                
                familyPlanBtn.style.display = 'none';
                familyCancelSection.style.display = 'block';
                
                premiumPlanBtn.textContent = 'Switch to Premium Plan';
                premiumPlanBtn.onclick = () => upgradePlan('premium');
                
                document.getElementById('cancelFamilyBtn').onclick = () => cancelSubscription('family');
            }
        }

        // Upgrade plan function
        async function upgradePlan(planName) {
            try {
                const result = await apiCall('/api/auth/upgrade-plan', {
                    method: 'POST',
                    body: JSON.stringify({ plan: planName })
                });

                // Update current user plan
                currentUser.plan = planName;
                
                // Update UI to reflect new plan
                updatePlanUI(planName);
                updateSubscriptionView(planName);
                updateSettingsView();
                
                showNotification(`Successfully upgraded to ${planName} plan!`);
                
            } catch (error) {
                showNotification('Error upgrading plan: ' + error.message, 'error');
            }
        }

        // Cancel subscription function
        async function cancelSubscription(currentPlan) {
            // Update PIN modal for cancellation
            document.getElementById('pinModalTitle').textContent = 'Verify PIN to Cancel Subscription';
            document.getElementById('pinModalDescription').textContent = 'For security reasons, please enter your PIN to cancel your subscription.';
            
            // Show PIN verification modal for cancellation
            currentAction = 'cancel_subscription';
            setupPinInputs();
            showModal('pinModal');
            
            // Store the current plan for cancellation
            window.pendingCancellationPlan = currentPlan;
        }

        // Handle subscription cancellation after PIN verification
        async function processSubscriptionCancellation(pin) {
            try {
                // Verify PIN first
                const verifyResult = await apiCall('/api/auth/verify-pin', {
                    method: 'POST',
                    body: JSON.stringify({ pin })
                });

                if (!verifyResult.success) {
                    throw new Error('Invalid PIN');
                }

                const currentPlan = window.pendingCancellationPlan;

                // If cancelling family plan, delete the family group first
                if (currentPlan === 'family') {
                    try {
                        await apiCall('/api/family', {
                            method: 'DELETE'
                        });
                        showNotification('Family group deleted and subscription cancelled.');
                    } catch (familyError) {
                        // If family deletion fails, still try to downgrade the plan
                        console.error('Family deletion failed:', familyError);
                        showNotification('Subscription cancelled, but could not delete family group.', 'warning');
                    }
                }

                // Downgrade to free plan
                const result = await apiCall('/api/auth/upgrade-plan', {
                    method: 'POST',
                    body: JSON.stringify({ plan: 'free' })
                });

                // Update current user plan
                currentUser.plan = 'free';
                
                // Update UI to reflect cancellation
                updatePlanUI('free');
                updateSubscriptionView('free');
                updateSettingsView();
                
                showNotification('Subscription cancelled successfully. You have been downgraded to the Free plan.');
                
            } catch (error) {
                showNotification('Error cancelling subscription: ' + error.message, 'error');
                throw error;
            }
        }

        // Update the verifyPin function to handle family vault
        async function verifyPin() {
            const inputs = document.querySelectorAll('#pinModal .pin-input');
            const pin = Array.from(inputs).map(input => input.value).join('');

            if (pin.length !== 4) {
                alert('Please enter a complete 4-digit PIN');
                return;
            }

            try {
                // Clear PIN inputs immediately for security
                inputs.forEach(input => input.value = '');
                
                if (currentAction === 'view') {
                    if (isSharedPassword) {
                        await loadSharedPasswordDetails(currentPasswordId, pin);
                    } else if (isFamilyVaultPassword) {
                        await loadFamilyVaultPasswordDetails(currentPasswordId, pin);
                    } else {
                        await loadPasswordDetailsWithPin(currentPasswordId, pin);
                    }
                } else if (currentAction === 'copy') {
                    if (isSharedPassword) {
                        await copySharedPasswordWithPin(currentPasswordId, pin);
                    } else if (isFamilyVaultPassword) {
                        await copyFamilyVaultPasswordWithPin(currentPasswordId, pin);
                    } else {
                        await copyPasswordWithPin(currentPasswordId, pin);
                    }
                    
                    } else if (currentAction === 'share_final') {
                        await completePasswordSharingWithPin(pin);
                    } else if (currentAction === 'cancel_subscription') {
                        await processSubscriptionCancellation(pin);
                    }
                
                closeModal('pinModal');
                
                // Clear pending cancellation
                if (currentAction === 'cancel_subscription') {
                    window.pendingCancellationPlan = null;
                }
                
            } catch (error) {
                alert('Invalid PIN or error: ' + error.message);
                setupPinInputs();
            }
        }

        // Update the updatePlanUI function
        function updatePlanUI(planName) {
            // Update sidebar upgrade card
            const upgradeCard = document.getElementById('sidebarUpgradeCard');
            if (upgradeCard) {
                if (planName !== 'free') {
                    upgradeCard.innerHTML = `
                        <div class="upgrade-icon" style="background: var(--success);">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="upgrade-title">${planName.charAt(0).toUpperCase() + planName.slice(1)} Plan</div>
                        <div class="upgrade-description">You're on the ${planName} plan. Enjoy premium features!</div>
                        <button class="upgrade-btn-sidebar" onclick="showDashboardView('subscription')">
                            Manage Subscription
                        </button>
                    `;
                } else {
                    upgradeCard.innerHTML = `
                        <div class="upgrade-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="upgrade-title">Upgrade to Premium</div>
                        <div class="upgrade-description">Unlock advanced security features and sharing capabilities</div>
                        <button class="upgrade-btn-sidebar" onclick="showDashboardView('subscription')">
                            Upgrade Now
                        </button>
                    `;
                }
            }

            // Update subscription view
            updateSubscriptionView(planName);
        }

        // Auth Functions
        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const pin = document.getElementById('registerPin').value;

            if (!name || !email || !password || !pin) {
                showAlert('registerAlert', 'Please fill in all fields');
                return;
            }

            if (pin.length !== 4) {
                showAlert('registerAlert', 'PIN must be 4 digits');
                return;
            }

            try {
                const result = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password, pin })
                });

                currentUser = { email, name, plan: 'free' };
                showAlert('registerAlert', 'Registration successful! Check your email for verification code.', 'success');
                
                // Auto-fill verification code for demo
                //document.getElementById('verifyCode').value = result.verificationCode || '123456';
                showAuthScreen('verifyScreen');
            } catch (error) {
                showAlert('registerAlert', error.message);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('loginAlert', 'Please fill in all fields');
                return;
            }

            try {
                const result = await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (result.needsVerification) {
                    showAlert('loginAlert', 'Please verify your email first');
                    showAuthScreen('verifyScreen');
                    return;
                }

                // CLEAR PREVIOUS STATE
                allPasswords = []; // Clear the cached passwords
                authToken = result.authToken;
                currentUser = result.user;
                
                // Update UI and show dashboard
                showDashboard();
                
            } catch (error) {
                showAlert('loginAlert', error.message);
            }
        }

        async function showDashboard() {
            console.log('=== showDashboard started ===');
            
            try {
                // Hide auth, show dashboard
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                
                // Update user info
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=4361ee&color=fff`;
                
                // Clear any cached passwords from previous session
                allPasswords = [];
                
                // Get the latest plan from database
                try {
                    const currentPlan = await getUserPlan();
                    currentUser.plan = currentPlan;
                    updatePlanUI(currentPlan);
                } catch (error) {
                    console.error('Error fetching user plan:', error);
                    updatePlanUI(currentUser.plan || 'free');
                }
                
                // Save to localStorage FIRST
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                console.log('Dashboard setup complete, loading data...');
                
                // Load dashboard stats
                await loadDashboardData();
                
                // Load passwords and update UI immediately
                await loadAndUpdatePasswords();
                
                console.log('=== showDashboard completed ===');
                
            } catch (error) {
                console.error('Error in showDashboard:', error);
                if (error.message.includes('auth') || error.message.includes('401') || error.message.includes('token')) {
                    logout();
                }
            }
        }

        async function loadAndUpdatePasswords() {
            try {
                console.log('Loading passwords from API...');
                const result = await apiCall('/api/passwords');
                allPasswords = result.passwords || [];
                console.log('Passwords loaded:', allPasswords.length);
                
                // Update UI immediately with the loaded passwords
                updatePasswordLists();
                
                // Also update dashboard stats with fresh data
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error loading passwords:', error);
                // Even if there's an error, try to update UI with empty state
                allPasswords = [];
                updatePasswordLists();
            }
        }

        async function verifyEmail() {
            const email = currentUser.email;
            const code = document.getElementById('verifyCode').value;

            if (!code) {
                showAlert('verifyAlert', 'Please enter verification code');
                return;
            }

            try {
                await apiCall('/api/auth/verify-email', {
                    method: 'POST',
                    body: JSON.stringify({ email, code })
                });

                showAlert('verifyAlert', 'Email verified successfully! You can now login.', 'success');
                setTimeout(() => {
                    showAuthScreen('loginScreen');
                }, 2000);
            } catch (error) {
                showAlert('verifyAlert', error.message);
            }
        }

        async function resendCode() {
            const email = currentUser.email;

            try {
                await apiCall('/api/auth/resend-code', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showAlert('verifyAlert', 'Verification code resent to your email', 'success');
            } catch (error) {
                showAlert('verifyAlert', error.message);
            }
        }

        // Forgot Password Functions
        function showForgotPassword() {
            showAuthScreen('forgotPasswordScreen');
        }

        async function sendResetLink() {
            const email = document.getElementById('forgotPasswordEmail').value;

            if (!email) {
                showAlert('forgotPasswordAlert', 'Please enter your email');
                return;
            }

            try {
                const result = await apiCall('/api/auth/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showAlert('forgotPasswordAlert', result.message, 'success');
                
                // For demo purposes, if we have a token, auto-fill the reset screen
                if (result.resetToken) {
                    localStorage.setItem('resetToken', result.resetToken);
                    document.getElementById('resetPassword').value = '';
                    document.getElementById('resetPasswordConfirm').value = '';
                    showAuthScreen('resetPasswordScreen');
                }
            } catch (error) {
                showAlert('forgotPasswordAlert', error.message);
            }
        }

        async function resetPassword() {
            const newPassword = document.getElementById('resetPassword').value;
            const confirmPassword = document.getElementById('resetPasswordConfirm').value;

            if (!newPassword || !confirmPassword) {
                showAlert('resetPasswordAlert', 'Please fill in all fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('resetPasswordAlert', 'Passwords do not match');
                return;
            }

            if (newPassword.length < 8) {
                showAlert('resetPasswordAlert', 'Password must be at least 8 characters');
                return;
            }

            // Get token from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token') || localStorage.getItem('resetToken');

            if (!token) {
                showAlert('resetPasswordAlert', 'Invalid reset token');
                return;
            }

            try {
                const result = await apiCall('/api/auth/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({ token, newPassword })
                });

                showAlert('resetPasswordAlert', 'Password reset successfully! You can now login with your new password.', 'success');
                
                // Clear token
                localStorage.removeItem('resetToken');
                
                setTimeout(() => {
                    showAuthScreen('loginScreen');
                }, 3000);
            } catch (error) {
                showAlert('resetPasswordAlert', error.message);
            }
        }

        function logout() {
            // Clear all frontend state
            currentUser = null;
            authToken = null;
            allPasswords = []; // Clear passwords cache
            
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // Show auth container, hide dashboard
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
            showAuthScreen('loginScreen');
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                const result = await apiCall('/api/dashboard/stats');
                const stats = result.stats;

                // Update dashboard cards
                document.getElementById('totalPasswords').textContent = stats.total;
                document.getElementById('weakPasswords').textContent = stats.weak;
                document.getElementById('totalCategories').textContent = stats.categories;
                
                // Calculate security score
                const securityScore = stats.total > 0 ? Math.round(((stats.total - stats.weak) / stats.total) * 100) : 100;
                document.getElementById('securityScore').textContent = securityScore + '%';
                document.getElementById('securityStatus').textContent = 
                    securityScore >= 80 ? 'Excellent' : 
                    securityScore >= 60 ? 'Good' : 'Needs Improvement';

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadRecentPasswords() {
            console.log('Starting loadRecentPasswords...');
            
            try {
                // Wait for the elements to be ready
                const loading = await waitForElement('recentPasswordsLoading').catch(() => null);
                const list = await waitForElement('recentPasswordsList').catch(() => null);

                if (!loading || !list) {
                    console.warn('Password elements not found, skipping password load');
                    return;
                }

                console.log('Elements found, loading passwords...');
                loading.style.display = 'block';
                list.innerHTML = '';

                const result = await apiCall('/api/passwords');
                allPasswords = result.passwords || [];
                
                loading.style.display = 'none';

                if (allPasswords.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                        <i class="fas fa-key"></i>
                        <h3>No passwords yet</h3>
                        <p>Add your first password to get started</p>
                        </div>
                    `;
                    return;
                }

                // Show only recent 5 passwords
                const recentPasswords = allPasswords.slice(0, 5);
                recentPasswords.forEach(password => {
                    const item = createPasswordItem(password);
                    list.appendChild(item);
                });

                console.log('Passwords loaded successfully:', allPasswords.length);

            } catch (error) {
                console.error('Error in loadRecentPasswords:', error);
                
                // Safely hide loading if it exists
                const loading = document.getElementById('recentPasswordsLoading');
                if (loading) loading.style.display = 'none';
                
                // Don't logout on DOM errors, just log them
                if (!error.message.includes('Element') && !error.message.includes('null')) {
                    // Only logout on actual auth errors
                    if (error.message.includes('401') || error.message.includes('authenticated')) {
                        logout();
                    }
                }
            }
        }

        async function loadAllPasswords() {
            const loading = document.getElementById('allPasswordsLoading');
            const list = document.getElementById('allPasswordsList');

            loading.style.display = 'block';
            list.innerHTML = '';

            try {
                const result = await apiCall('/api/passwords');
                
                // CLEAR AND REFRESH THE CACHE
                allPasswords = result.passwords || []; // Always replace, don't append
                
                loading.style.display = 'none';

                if (allPasswords.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                        <i class="fas fa-key"></i>
                        <h3>No passwords yet</h3>
                        <p>Add your first password to get started</p>
                        </div>
                    `;
                    return;
                }

                allPasswords.forEach(password => {
                    const item = createPasswordItem(password);
                    list.appendChild(item);
                });

            } catch (error) {
                loading.style.display = 'none';
                console.error('Error loading passwords:', error);
            }
        }

        function createPasswordItem(password) {
            const item = document.createElement('div');
            item.className = 'password-item';
            
            const strengthClass = password.strength_score >= 4 ? 'strong' : 
                                    password.strength_score >= 2 ? 'medium' : 'weak';

            const shareButton = (currentUser.plan === 'premium' || currentUser.plan === 'family') ? 
                `<button class="action-btn share-password" data-id="${password.id}" title="Share Password">
                    <i class="fas fa-share-alt"></i>
                </button>` : '';

            const shareToVaultButton = (currentUser.plan === 'family') ? 
                `<button class="action-btn share-to-vault" data-id="${password.id}" title="Share to Family Vault">
                    <i class="fas fa-home"></i>
                </button>` : '';

            item.innerHTML = `
                <div class="password-icon">${password.website.charAt(0).toUpperCase()}</div>
                <div class="password-details">
                    <div class="password-name">${password.website}</div>
                    <div class="password-username">${password.username}</div>
                </div>
                <div class="password-actions">
                    ${shareToVaultButton}
                    ${shareButton}
                    <button class="action-btn view-password" data-id="${password.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn copy-password" data-id="${password.id}">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="action-btn delete-password" data-id="${password.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            // Add event listeners
            item.querySelector('.view-password').addEventListener('click', function(e) {
                e.stopPropagation();
                showPasswordDetails(password.id);
            });

            item.querySelector('.copy-password').addEventListener('click', function(e) {
                e.stopPropagation();
                copyPasswordToClipboard(password.id);
            });

            item.querySelector('.delete-password').addEventListener('click', function(e) {
                e.stopPropagation();
                deletePassword(password.id);
            });

            // Add share button listener if available
            const shareBtn = item.querySelector('.share-password');
            if (shareBtn) {
                shareBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showSharePasswordModal(password.id);
                });
            }

            // Add share to vault button listener if available
            const shareToVaultBtn = item.querySelector('.share-to-vault');
            if (shareToVaultBtn) {
                shareToVaultBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showShareToFamilyVaultModal(password.id);
                });
            }

            return item;
        }

        function updatePasswordLists() {
            // Update Recent Passwords list (only if on dashboard view)
            if (document.getElementById('dashboardView').style.display !== 'none') {
                const recentList = document.getElementById('recentPasswordsList');
                const recentPasswords = allPasswords.slice(0, 5);
                
                recentList.innerHTML = '';
                if (recentPasswords.length === 0) {
                    recentList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-key"></i>
                            <h3>No passwords yet</h3>
                            <p>Add your first password to get started</p>
                        </div>
                    `;
                } else {
                    recentPasswords.forEach(password => {
                        const item = createPasswordItem(password);
                        recentList.appendChild(item);
                    });
                }
            }

            // Update All Passwords list (only if on passwords view)
            if (document.getElementById('passwordsView').style.display !== 'none') {
                const allList = document.getElementById('allPasswordsList');
                allList.innerHTML = '';
                if (allPasswords.length === 0) {
                    allList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-key"></i>
                            <h3>No passwords yet</h3>
                            <p>Add your first password to get started</p>
                        </div>
                    `;
                } else {
                    allPasswords.forEach(password => {
                        const item = createPasswordItem(password);
                        allList.appendChild(item);
                    });
                }
            }
        }

        function searchPasswords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const currentView = document.querySelector('#dashboardView').style.display !== 'none' ? 
                            'recentPasswordsList' : 'allPasswordsList';
            const list = document.getElementById(currentView);
            
            const items = list.querySelectorAll('.password-item');
            items.forEach(item => {
                const website = item.querySelector('.password-name').textContent.toLowerCase();
                const username = item.querySelector('.password-username').textContent.toLowerCase();
                
                if (website.includes(searchTerm) || username.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Password Management
        function showAddPasswordModal() {
            document.getElementById('passwordWebsite').value = '';
            document.getElementById('passwordUsername').value = '';
            document.getElementById('passwordValue').value = '';
            document.getElementById('passwordCategory').value = 'Personal';
            document.getElementById('passwordUrl').value = '';
            document.getElementById('passwordNotes').value = '';
            document.getElementById('passwordStrength').className = 'security-strength';
            showModal('addPasswordModal');
        }

        // Password strength indicator
        document.getElementById('passwordValue').addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 8) strength += 1;
            if (password.length >= 12) strength += 1;
            if (/[a-z]/.test(password)) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            const strengthBar = document.getElementById('passwordStrength');
            strengthBar.className = 'security-strength';
            
            if (strength <= 2) {
                strengthBar.classList.add('security-weak');
            } else if (strength <= 4) {
                strengthBar.classList.add('security-medium');
            } else {
                strengthBar.classList.add('security-strong');
            }
        });

        async function addPassword() {
            const website = document.getElementById('passwordWebsite').value;
            const username = document.getElementById('passwordUsername').value;
            const password = document.getElementById('passwordValue').value;
            const category = document.getElementById('passwordCategory').value;
            const url = document.getElementById('passwordUrl').value;
            const notes = document.getElementById('passwordNotes').value;

            if (!website || !username || !password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                await apiCall('/api/passwords', {
                    method: 'POST',
                    body: JSON.stringify({
                        website,
                        username,
                        password,
                        category,
                        url,
                        notes
                    })
                });

                closeModal('addPasswordModal');
                
                // Clear the form
                document.getElementById('passwordWebsite').value = '';
                document.getElementById('passwordUsername').value = '';
                document.getElementById('passwordValue').value = '';
                document.getElementById('passwordCategory').value = 'Personal';
                document.getElementById('passwordUrl').value = '';
                document.getElementById('passwordNotes').value = '';
                
                // USE OUR NEW APPROACH - Load and update passwords
                await loadAndUpdatePasswords();
                
                showNotification('Password saved successfully!');
                
            } catch (error) {
                showNotification('Error adding password: ' + error.message, 'error');
            }
        }

        async function showPasswordDetails(passwordId, isShared = false) {
            currentPasswordId = passwordId;
            currentAction = 'view';
            isSharedPassword = isShared;
            isFamilyVaultPassword = false;
            
            // Reset PIN modal to default view
            document.getElementById('pinModalTitle').textContent = 'Enter PIN to View Password';
            document.getElementById('pinModalDescription').textContent = 'For security reasons, please enter your PIN to view this password.';
            setupPinInputs();
            showModal('pinModal');
        }


        async function loadSharedPasswordDetails(shareId, pin) {
    try {
        const result = await apiCall(`/api/shared-passwords/${shareId}/view`, {
            method: 'POST',
            body: JSON.stringify({ pin })
        });

        const password = result.password;

        document.getElementById('passwordDetailsTitle').textContent = password.website;
        document.getElementById('detailWebsite').textContent = password.website;
        document.getElementById('detailUsername').textContent = password.username;
        document.getElementById('detailPassword').value = password.password;
        document.getElementById('detailCategory').textContent = password.category;
        document.getElementById('detailUrl').textContent = password.url || 'N/A';
        document.getElementById('detailNotes').textContent = password.notes || 'No notes';

        // Show shared by information
        document.getElementById('sharedPasswordInfo').style.display = 'block';
        document.getElementById('detailSharedBy').textContent = password.shared_by || 'Unknown';

        showModal('passwordDetailsModal');
    } catch (error) {
        throw new Error('Failed to load shared password details');
    }
}

async function copySharedPasswordWithPin(shareId, pin) {
    try {
        const result = await apiCall(`/api/shared-passwords/${shareId}/view`, {
            method: 'POST',
            body: JSON.stringify({ pin })
        });
        
        const passwordText = result.password.password;
        
        await navigator.clipboard.writeText(passwordText);
        
        // Clear clipboard after 30 seconds for security
        setTimeout(async () => {
            try {
                await navigator.clipboard.writeText('');
            } catch (e) {
                // Ignore clipboard clearing errors
            }
        }, 30000);
        
        showNotification('Password copied to clipboard! It will be cleared in 30 seconds.');
    } catch (error) {
        throw new Error('Failed to copy shared password');
    }
}

        function setupPinInputs() {
            const inputs = document.querySelectorAll('#pinModal .pin-input');
            inputs.forEach((input, index) => {
                input.value = '';
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
            inputs[0].focus();
        }

        async function loadPasswordDetailsWithPin(passwordId, pin) {
            try {
                let result;
                
                if (isSharedPassword) {
                    // Use shared password endpoint
                    result = await apiCall(`/api/shared-passwords/${passwordId}/view`, {
                        method: 'POST',
                        body: JSON.stringify({ pin })
                    });
                } else {
                    // Use regular password endpoint
                    result = await apiCall(`/api/passwords/${passwordId}/view`, {
                        method: 'POST',
                        body: JSON.stringify({ pin })
                    });
                }

                const password = result.password;

                document.getElementById('passwordDetailsTitle').textContent = password.website;
                document.getElementById('detailWebsite').textContent = password.website;
                document.getElementById('detailUsername').textContent = password.username;
                document.getElementById('detailPassword').value = password.password;
                document.getElementById('detailCategory').textContent = password.category;
                document.getElementById('detailUrl').textContent = password.url || 'N/A';
                document.getElementById('detailNotes').textContent = password.notes || 'No notes';

                // Show shared by information if it's a shared password
                if (password.is_shared || password.shared_by) {
                    document.getElementById('sharedPasswordInfo').style.display = 'block';
                    document.getElementById('detailSharedBy').textContent = password.shared_by || 'Unknown';
                } else {
                    document.getElementById('sharedPasswordInfo').style.display = 'none';
                }

                showModal('passwordDetailsModal');
            } catch (error) {
                throw new Error('Failed to load password details');
            }
        }

        function copyPassword() {
            const passwordField = document.getElementById('detailPassword');
            passwordField.select();
            document.execCommand('copy');
            showNotification('Password copied to clipboard!');
        }

        async function copyPasswordToClipboard(passwordId, isShared = false) {
            currentPasswordId = passwordId;
            currentAction = 'copy';
            isSharedPassword = isShared;
            isFamilyVaultPassword = false;
            
            // Reset PIN modal to default view
            document.getElementById('pinModalTitle').textContent = 'Enter PIN to Copy Password';
            document.getElementById('pinModalDescription').textContent = 'For security reasons, please enter your PIN to copy this password.';
            setupPinInputs();
            showModal('pinModal');
        }

        async function copyPasswordWithPin(passwordId, pin) {
            try {
                let result;
                
                if (isSharedPassword) {
                    // Use shared password endpoint
                    result = await apiCall(`/api/shared-passwords/${passwordId}/view`, {
                        method: 'POST',
                        body: JSON.stringify({ pin })
                    });
                } else {
                    // Use regular password endpoint
                    result = await apiCall(`/api/passwords/${passwordId}/view`, {
                        method: 'POST',
                        body: JSON.stringify({ pin })
                    });
                }
                
                const passwordText = result.password.password;
                
                // Use modern clipboard API
                await navigator.clipboard.writeText(passwordText);
                
                // Clear clipboard after 30 seconds for security
                setTimeout(async () => {
                    try {
                        await navigator.clipboard.writeText('');
                    } catch (e) {
                        // Ignore clipboard clearing errors
                    }
                }, 30000);
                
                showNotification('Password copied to clipboard! It will be cleared in 30 seconds.');
            } catch (error) {
                throw new Error('Failed to copy password');
            }
        }

        async function deletePassword(passwordId) {
            if (!confirm('Are you sure you want to delete this password? This action cannot be undone.')) {
                return;
            }

            try {
                await apiCall(`/api/passwords/${passwordId}`, {
                    method: 'DELETE'
                });

                // USE OUR NEW APPROACH - Load and update passwords
                await loadAndUpdatePasswords();
                
                showNotification('Password deleted successfully!');
                
            } catch (error) {
                showNotification('Error deleting password: ' + error.message, 'error');
            }
        }

        // Family Vault Functions
        function showAddFamilyVaultModal() {
            document.getElementById('familyVaultWebsite').value = '';
            document.getElementById('familyVaultUsername').value = '';
            document.getElementById('familyVaultPassword').value = '';
            document.getElementById('familyVaultShareWith').value = 'all';
            document.getElementById('familyVaultCategory').value = 'Entertainment';
            document.getElementById('familyVaultUrl').value = '';
            document.getElementById('familyVaultNotes').value = '';
            document.getElementById('familyVaultPasswordStrength').className = 'security-strength';
            
            // Load family members for specific sharing
            loadFamilyMembersForSharing();
            showModal('addFamilyVaultModal');
        }

        function showShareToFamilyVaultModal(passwordId) {
            currentPasswordForSharing = passwordId;
            document.getElementById('shareToFamilyVaultWith').value = 'all';
            
            // Load family members for specific sharing
            loadFamilyMembersForSharing('share');
            showModal('shareToFamilyVaultModal');
        }

        async function loadFamilyMembersForSharing(type = 'add') {
            try {
                const result = await apiCall('/api/family/vault/members');
                const members = result.members || [];
                
                const selectElement = document.getElementById(
                    type === 'add' ? 'familyVaultSpecificMember' : 'shareToFamilyVaultSpecificMember'
                );
                const groupElement = document.getElementById(
                    type === 'add' ? 'specificMemberGroup' : 'shareSpecificMemberGroup'
                );
                
                selectElement.innerHTML = '<option value="">Select a family member</option>';
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.name} (${member.role})`;
                    selectElement.appendChild(option);
                });
                
                // Show/hide specific member group based on share type selection
                const shareWithElement = document.getElementById(
                    type === 'add' ? 'familyVaultShareWith' : 'shareToFamilyVaultWith'
                );
                
                shareWithElement.addEventListener('change', function() {
                    groupElement.style.display = this.value === 'specific' ? 'block' : 'none';
                });
                
            } catch (error) {
                console.error('Error loading family members:', error);
            }
        }

        async function addToFamilyVault() {
            const website = document.getElementById('familyVaultWebsite').value;
            const username = document.getElementById('familyVaultUsername').value;
            const password = document.getElementById('familyVaultPassword').value;
            const shareWith = document.getElementById('familyVaultShareWith').value;
            const specificMember = document.getElementById('familyVaultSpecificMember').value;
            const category = document.getElementById('familyVaultCategory').value;
            const url = document.getElementById('familyVaultUrl').value;
            const notes = document.getElementById('familyVaultNotes').value;

            if (!website || !username || !password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const finalShareWith = shareWith === 'specific' ? specificMember : shareWith;

            if (shareWith === 'specific' && !specificMember) {
                showNotification('Please select a family member', 'error');
                return;
            }

            try {
                await apiCall('/api/family/vault/passwords', {
                    method: 'POST',
                    body: JSON.stringify({
                        website,
                        username,
                        password,
                        shareWith: finalShareWith,
                        category,
                        url,
                        notes
                    })
                });

                closeModal('addFamilyVaultModal');
                showNotification('Password added to family vault successfully!');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error adding to family vault: ' + error.message, 'error');
            }
        }

        async function shareToFamilyVault() {
            const shareWith = document.getElementById('shareToFamilyVaultWith').value;
            const specificMember = document.getElementById('shareToFamilyVaultSpecificMember').value;

            if (!currentPasswordForSharing) {
                showNotification('No password selected for sharing', 'error');
                return;
            }

            const finalShareWith = shareWith === 'specific' ? specificMember : shareWith;

            if (shareWith === 'specific' && !specificMember) {
                showNotification('Please select a family member', 'error');
                return;
            }

            try {
                await apiCall(`/api/passwords/${currentPasswordForSharing}/share-to-family`, {
                    method: 'POST',
                    body: JSON.stringify({
                        shareWith: finalShareWith
                    })
                });

                closeModal('shareToFamilyVaultModal');
                showNotification('Password shared to family vault successfully!');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error sharing to family vault: ' + error.message, 'error');
            }
        }

        async function showFamilyVaultPasswordDetails(passwordId) {
            currentPasswordId = passwordId;
            currentAction = 'view';
            isFamilyVaultPassword = true;
            isSharedPassword = false;
            
            document.getElementById('pinModalTitle').textContent = 'Enter PIN to View Family Vault Password';
            document.getElementById('pinModalDescription').textContent = 'For security reasons, please enter your PIN to view this family vault password.';
            setupPinInputs();
            showModal('pinModal');
        }

        async function loadFamilyVaultPasswordDetails(passwordId, pin) {
            try {
                const result = await apiCall(`/api/family/vault/passwords/${passwordId}/view`, {
                    method: 'POST',
                    body: JSON.stringify({ pin })
                });

                const password = result.password;

                document.getElementById('passwordDetailsTitle').textContent = `${password.website} (Family Vault)`;
                document.getElementById('detailWebsite').textContent = password.website;
                document.getElementById('detailUsername').textContent = password.username;
                document.getElementById('detailPassword').value = password.password;
                document.getElementById('detailCategory').textContent = password.category;
                document.getElementById('detailUrl').textContent = password.url || 'N/A';
                document.getElementById('detailNotes').textContent = password.notes || 'No notes';

                // Show family vault specific info
                document.getElementById('sharedPasswordInfo').style.display = 'block';
                document.getElementById('detailSharedBy').textContent = `Added by: ${password.added_by_name}`;

                showModal('passwordDetailsModal');
            } catch (error) {
                throw new Error('Failed to load family vault password details');
            }
        }

        async function copyFamilyVaultPassword(passwordId) {
            currentPasswordId = passwordId;
            currentAction = 'copy';
            isFamilyVaultPassword = true;
            isSharedPassword = false;
            
            document.getElementById('pinModalTitle').textContent = 'Enter PIN to Copy Family Vault Password';
            document.getElementById('pinModalDescription').textContent = 'For security reasons, please enter your PIN to copy this family vault password.';
            setupPinInputs();
            showModal('pinModal');
        }

        async function copyFamilyVaultPasswordWithPin(passwordId, pin) {
            try {
                const result = await apiCall(`/api/family/vault/passwords/${passwordId}/view`, {
                    method: 'POST',
                    body: JSON.stringify({ pin })
                });
                
                const passwordText = result.password.password;
                
                await navigator.clipboard.writeText(passwordText);
                
                // Clear clipboard after 30 seconds for security
                setTimeout(async () => {
                    try {
                        await navigator.clipboard.writeText('');
                    } catch (e) {
                        // Ignore clipboard clearing errors
                    }
                }, 30000);
                
                showNotification('Family vault password copied to clipboard! It will be cleared in 30 seconds.');
            } catch (error) {
                throw new Error('Failed to copy family vault password');
            }
        }

        async function removeFromFamilyVault(passwordId) {
            if (!confirm('Are you sure you want to remove this password from the family vault?')) {
                return;
            }

            try {
                await apiCall(`/api/family/vault/passwords/${passwordId}`, {
                    method: 'DELETE'
                });

                showNotification('Password removed from family vault successfully!');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error removing from family vault: ' + error.message, 'error');
            }
        }

        // Sharing functions
        function showSharePasswordModal(passwordId = null) {
    currentPasswordForSharing = passwordId;
    document.getElementById('shareEmail').value = '';
    document.getElementById('shareAccessLevel').value = 'view';
    document.getElementById('shareExpires').value = '';
    showModal('sharePasswordModal');
}

        async function sharePassword() {
    const email = document.getElementById('shareEmail').value;
    const accessLevel = document.getElementById('shareAccessLevel').value;
    const expiresInHours = document.getElementById('shareExpires').value;

    if (!email) {
        showNotification('Please enter recipient email', 'error');
        return;
    }

    if (!currentPasswordForSharing) {
        showNotification('No password selected for sharing', 'error');
        return;
    }

    // Close the share modal first
    closeModal('sharePasswordModal');
    
    // Then show PIN verification modal
    document.getElementById('pinModalTitle').textContent = 'Enter PIN to Share Password';
    document.getElementById('pinModalDescription').textContent = 'For security reasons, please enter your PIN to complete sharing.';
    currentAction = 'share_final';
    setupPinInputs();
    showModal('pinModal');
}

        // Family sharing functions
        function showCreateFamilyModal() {
            document.getElementById('familyName').value = 'My Family';
            showModal('createFamilyModal');
        }

        async function createFamilyGroup() {
            const name = document.getElementById('familyName').value;

            if (!name) {
                showNotification('Please enter a family group name', 'error');
                return;
            }

            try {
                await apiCall('/api/family/create', {
                    method: 'POST',
                    body: JSON.stringify({ name })
                });

                closeModal('createFamilyModal');
                showNotification('Family group created successfully');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error creating family group: ' + error.message, 'error');
            }
        }

        function showInviteFamilyModal() {
            document.getElementById('familyInviteEmail').value = '';
            document.getElementById('familyMemberRole').value = 'child';
            updateRolePermissions();
            showModal('inviteFamilyModal');
        }


        async function verifyPinForSharing(pin) {
    try {
        // Verify the PIN first
        const verifyResult = await apiCall('/api/auth/verify-pin', {
            method: 'POST',
            body: JSON.stringify({ pin })
        });

        if (!verifyResult.success) {
            throw new Error('Invalid PIN');
        }

        // PIN is valid, now show the share password modal
        showSharePasswordForm();
        
    } catch (error) {
        throw new Error('Failed to verify PIN for sharing');
    }
}
function showSharePasswordForm() {
    document.getElementById('shareEmail').value = '';
    document.getElementById('shareAccessLevel').value = 'view';
    document.getElementById('shareExpires').value = '';
    showModal('sharePasswordModal');
}

async function revokeShare(shareId) {
            if (!confirm('Are you sure you want to revoke this password share?')) {
                return;
            }

            try {
                await apiCall(`/api/shared-passwords/${shareId}`, {
                    method: 'DELETE'
                });

                showNotification('Password share revoked successfully');
                
                // Refresh the sharing center view
                loadSharingCenterContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error revoking share: ' + error.message, 'error');
            }
        }
        function updateRolePermissions() {
            const role = document.getElementById('familyMemberRole').value;
            const permissionsDiv = document.getElementById('rolePermissions');
            
            if (role === 'parent') {
                permissionsDiv.innerHTML = `
                    <ul style="padding-left: 20px; margin: 0;">
                        <li>Full access to all family passwords</li>
                        <li>Can invite and manage family members</li>
                        <li>Can enable emergency access</li>
                    </ul>
                `;
            } else {
                permissionsDiv.innerHTML = `
                    <ul style="padding-left: 20px; margin: 0;">
                        <li>Access to passwords shared by parents</li>
                        <li>Cannot invite new members</li>
                        <li>Limited management capabilities</li>
                    </ul>
                `;
            }
        }

        async function inviteFamilyMember() {
            const email = document.getElementById('familyInviteEmail').value;
            const role = document.getElementById('familyMemberRole').value;

            if (!email) {
                showNotification('Please enter family member email', 'error');
                return;
            }

            try {
                const result = await apiCall('/api/family/invite', {
                    method: 'POST',
                    body: JSON.stringify({ email, role })
                });

                closeModal('inviteFamilyModal');
                
                if (result.requiresSignup) {
                    showNotification('Invitation sent! User will need to sign up for SecurePass first.');
                } else {
                    showNotification('Family invitation sent successfully');
                }
                
            } catch (error) {
                showNotification('Error sending invitation: ' + error.message, 'error');
            }
        }

        async function removeFamilyMember(memberId) {
            if (!confirm('Are you sure you want to remove this family member?')) {
                return;
            }

            try {
                await apiCall(`/api/family/members/${memberId}`, {
                    method: 'DELETE'
                });

                showNotification('Family member removed successfully');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error removing family member: ' + error.message, 'error');
            }
        }

        async function enableEmergencyAccess() {
            if (!confirm('Enable emergency access? This will grant all family members access to shared passwords until disabled.')) {
                return;
            }

            try {
                await apiCall('/api/family/emergency-access/enable', {
                    method: 'POST'
                });

                showNotification('Emergency access enabled successfully');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error enabling emergency access: ' + error.message, 'error');
            }
        }

        async function disableEmergencyAccess() {
            if (!confirm('Disable emergency access?')) {
                return;
            }

            try {
                await apiCall('/api/family/emergency-access/disable', {
                    method: 'POST'
                });

                showNotification('Emergency access disabled successfully');
                
                // Refresh the family sharing view
                loadFamilySharingContent(currentUser.plan);
                
            } catch (error) {
                showNotification('Error disabling emergency access: ' + error.message, 'error');
            }
        }

        // Family deletion functions
        function showDeleteFamilyModal() {
            document.getElementById('deleteFamilyPassword').value = '';
            document.getElementById('deleteFamilyConfirmation').value = '';
            showModal('deleteFamilyModal');
        }

        async function deleteFamilyGroup() {
  const password = document.getElementById('deleteFamilyPassword').value;
  const confirmation = document.getElementById('deleteFamilyConfirmation').value;

  if (!password) {
    showNotification('Please enter your password', 'error');
    return;
  }

  if (confirmation !== 'DELETE FAMILY') {
    showNotification('Please type "DELETE FAMILY" to confirm', 'error');
    return;
  }

  if (!confirm('Are you absolutely sure? This will permanently delete your family group and remove all family members. Members will be restored to their previous plans. This action cannot be undone.')) {
    return;
  }

  try {
    // Show loading state
    const deleteBtn = document.querySelector('#deleteFamilyModal .btn-danger');
    const originalText = deleteBtn.textContent;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    deleteBtn.disabled = true;

    // First verify the password by attempting to login
    await apiCall('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({
        email: currentUser.email,
        password: password
      })
    });

    // Delete the family group
    const result = await apiCall('/api/family', {
      method: 'DELETE'
    });

    // Reset button state
    deleteBtn.innerHTML = originalText;
    deleteBtn.disabled = false;

    closeModal('deleteFamilyModal');
    
    // Owner keeps family plan, no need to downgrade
    showNotification('Family group deleted successfully. Members have been restored to their previous plans.', 'success');
    
    // Refresh the family sharing view
    loadFamilySharingContent('family');
    
    // Update settings view
    updateSettingsView();
    
  } catch (error) {
    // Reset button state
    const deleteBtn = document.querySelector('#deleteFamilyModal .btn-danger');
    deleteBtn.textContent = 'Delete Family Group';
    deleteBtn.disabled = false;

    console.error('Delete family error details:', error);
    
    let userMessage = 'Error deleting family group: ';
    
    if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
      userMessage += 'Service temporarily unavailable. Please try again later.';
    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
      userMessage += 'Network error. Please check your connection and try again.';
    } else if (error.message.includes('401') || error.message.includes('unauthorized')) {
      userMessage += 'Invalid password. Please check your password and try again.';
    } else if (error.message.includes('403')) {
      userMessage += 'Only the family owner can delete the family group.';
    } else if (error.message.includes('404')) {
      userMessage += 'Family group not found or already deleted.';
    } else {
      userMessage += error.message;
    }
    
    showNotification(userMessage, 'error');
  }
}

        // Account Deletion Functions
        function showDeleteAccountModal() {
            document.getElementById('deleteAccountPassword').value = '';
            document.getElementById('deleteConfirmation').value = '';
            showModal('deleteAccountModal');
        }

        async function deleteAccount() {
            const password = document.getElementById('deleteAccountPassword').value;
            const confirmation = document.getElementById('deleteConfirmation').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (confirmation !== 'DELETE') {
                showNotification('Please type "DELETE" to confirm', 'error');
                return;
            }

            if (!confirm('Are you absolutely sure? This will permanently delete your account and all your passwords. This action cannot be undone.')) {
                return;
            }

            try {
                // Show loading state
                const deleteBtn = document.querySelector('#deleteAccountModal .btn-danger');
                const originalText = deleteBtn.textContent;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteBtn.disabled = true;

                // First verify the password by attempting to login
                await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: currentUser.email,
                        password: password
                    })
                });

                // Now call the DELETE endpoint - no request body needed
                // The auth token in the header identifies the user
                const result = await apiCall('/api/auth/delete-account', {
                    method: 'DELETE'
                    // No body needed - backend uses auth token to identify user
                });

                // Reset button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;

                closeModal('deleteAccountModal');
                showNotification('Account deleted successfully', 'success');
                
                // Logout and redirect to login
                setTimeout(() => {
                    logout();
                }, 2000);
                
            } catch (error) {
                // Reset button state
                const deleteBtn = document.querySelector('#deleteAccountModal .btn-danger');
                deleteBtn.textContent = 'Delete Account';
                deleteBtn.disabled = false;

                console.error('Delete account error details:', error);
                
                // Enhanced error handling
                let userMessage = 'Error deleting account: ';
                
                if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
                    userMessage += 'Service temporarily unavailable. Please try again later.';
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    userMessage += 'Network error. Please check your connection and try again.';
                } else if (error.message.includes('401') || error.message.includes('unauthorized')) {
                    userMessage += 'Invalid password. Please check your password and try again.';
                } else if (error.message.includes('404')) {
                    userMessage += 'Account not found or already deleted.';
                } else {
                    userMessage += error.message;
                }
                
                showNotification(userMessage, 'error');
            }
        }

        async function completePasswordSharingWithPin(pin) {
    try {
        // Verify PIN first
        const verifyResult = await apiCall('/api/auth/verify-pin', {
            method: 'POST',
            body: JSON.stringify({ pin })
        });

        if (!verifyResult.success) {
            throw new Error('Invalid PIN');
        }

        // PIN is valid, now make the actual share API call
        const email = document.getElementById('shareEmail').value;
        const accessLevel = document.getElementById('shareAccessLevel').value;
        const expiresInHours = document.getElementById('shareExpires').value;

        const result = await apiCall(`/api/passwords/${currentPasswordForSharing}/share`, {
            method: 'POST',
            headers: {
                'X-PIN-Verification': pin
            },
            body: JSON.stringify({
                email,
                accessLevel,
                expiresInHours: expiresInHours ? parseInt(expiresInHours) : null
            })
        });

        // Don't close share modal again since we already closed it
        // closeModal('sharePasswordModal'); // Remove this line
        
        if (result.requiresSignup) {
            showNotification('Invitation sent. User will be able to accept after signing up.');
        } else {
            showNotification(`Password shared successfully with ${result.sharedWith}`);
        }

        // Refresh the sharing center view
        loadSharingCenterContent(currentUser.plan);
        
    } catch (error) {
        showNotification('Error sharing password: ' + error.message, 'error');
        // Optionally, you could reopen the share modal here if you want the user to try again
        showModal('sharePasswordModal');
    }
}

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize dark mode
            initializeDarkMode();
            
            // Set up event listeners for settings
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
            document.getElementById('biometricToggle').addEventListener('change', toggleBiometricOptions);
            
            // Set up role permissions listener
            const roleSelect = document.getElementById('familyMemberRole');
            if (roleSelect) {
                roleSelect.addEventListener('change', updateRolePermissions);
            }
            
            // Check if we have a reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');
            
            if (resetToken) {
                localStorage.setItem('resetToken', resetToken);
                showAuthScreen('resetPasswordScreen');
                return;
            }
            
            // Check if user is already logged in
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showDashboard();
            } else {
                showAuthScreen('loginScreen');
            }
        });

        // Utility function to wait for DOM elements to be ready
        function waitForElement(selector, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                function checkElement() {
                    const element = document.getElementById(selector);
                    if (element) {
                        resolve(element);
                    } else if (Date.now() - startTime >= timeout) {
                        reject(new Error(`Element ${selector} not found after ${timeout}ms`));
                    } else {
                        setTimeout(checkElement, 100);
                    }
                }
                
                checkElement();
            });
        }

        // FIXED: Event delegation for invitation buttons
        document.addEventListener('click', async function(e) {
            // Handle accept invitation
            if (e.target.closest('.accept-invite')) {
                e.preventDefault();
                const button = e.target.closest('.accept-invite');
                const token = button.getAttribute('data-token');
                
                if (confirm('Join this family? You will get Family plan benefits!')) {
                    try {
                        const result = await apiCall('/api/family/accept-invitation', {
                            method: 'POST',
                            body: JSON.stringify({ token })
                        });
                        
                        // Update user plan and UI
                        currentUser.plan = 'family';
                        updatePlanUI('family');
                        showNotification(` Welcome to Family plan! Joined ${result.familyName} as ${result.role}`);
                        
                        // Refresh the view
                        loadFamilySharingContent('family');
                        
                    } catch (error) {
                        showNotification('Error: ' + error.message, 'error');
                    }
                }
            }
            
            // Handle decline invitation
            if (e.target.closest('.decline-invite')) {
                e.preventDefault();
                const button = e.target.closest('.decline-invite');
                const token = button.getAttribute('data-token');
                
                if (confirm('Decline this family invitation?')) {
                    try {
                        await apiCall('/api/family/decline-invitation', {
                            method: 'POST',
                            body: JSON.stringify({ token })
                        });
                        
                        showNotification('Invitation declined');
                        loadFamilySharingContent(currentUser.plan);
                        
                    } catch (error) {
                        showNotification('Error: ' + error.message, 'error');
                    }
                }
            }
        });

                function showLeaveFamilyModal() {
        // Check if user is a child account first
        checkFamilyOwnershipAndRole().then(({ isOwner, role }) => {
            if (role === 'child') {
            showNotification('Child accounts cannot leave the family. Please ask the family owner to remove you.', 'error');
            return;
            }
            
            if (isOwner) {
            showNotification('Family owners cannot leave the family. Please delete the family group instead.', 'error');
            return;
            }
            
            // For parent accounts, show confirmation
            if (confirm('Are you sure you want to leave this family group? You will be restored to your previous plan.')) {
            leaveFamilyGroup();
            }
        }).catch(error => {
            showNotification('Error checking family role: ' + error.message, 'error');
        });
        }

        async function leaveFamilyGroup() {
        try {
            const result = await apiCall('/api/family/leave', {
            method: 'POST'
        });

        // Update user's plan to what they were restored to
        currentUser.plan = result.newPlan;
        updatePlanUI(result.newPlan);
        updateSubscriptionView(result.newPlan);
        updateSettingsView();
    
        showNotification(`You have left the family group successfully. Restored to ${result.newPlan} plan.`, 'success');
    
        // Refresh the family sharing view
        loadFamilySharingContent(result.newPlan);
    
        } catch (error) {
            if (error.message.includes('Child accounts cannot leave')) {
            showNotification('Child accounts cannot leave the family. Please ask the family owner to remove you.', 'error');
            } else if (error.message.includes('Family owner cannot leave')) {
            showNotification('Family owners cannot leave the family. Please delete the family group instead.', 'error');
            } else {
            showNotification('Error leaving family group: ' + error.message, 'error');
            }
        }
    }

    </script>
</body>
</html>